<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Mark's Code Fractal CFKBase 3.1 Code Fractal Knowledge Base
 *
 *	Copyright 2016-2025 Mark Stephen Sobkow
 *
 *	This file is part of Mark's Code Fractal CFKBase.
 *
 *	Mark's Code Fractal CFKBase is available under dual commercial license from
 *	Mark Stephen Sobkow, or under the terms of the GNU General Public License,
 *	Version 3 or later.
 *
 *	Mark's Code Fractal CFKBase is free software: you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	Mark's Code Fractal CFKBase is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Mark's Code Fractal CFKBase.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 *
 *	If you wish to modify and use this code without publishing your changes,
 *	or integrate it with proprietary code, please contact Mark Stephen Sobkow
 *	for a commercial license at mark.sobkow@gmail.com
 * -->
<RuleSet
	xmlns="http://msscf.org:8088/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xsi:schemaLocation="http://msscf.org:8088/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd http://msscf.org:8088/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	ToolSet="java"
	Name="src/schemaappsetup/SchemaAppSetup.java"
	Revision="3.0"
	Descr="Java Application Setup main">

	<GenFile GenDef="SchemaDef" Name="fileSchemaAppSetupJava"
			GenerateOnce="false"
		ModuleName="$reference ManufacturingSchema lower JavaPackage$"
		SourceBundle="java"
		BasePackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup/src/main/java"
		SubPackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup"
		ExpansionClassName="$SchemaName$AppSetupJava"
		ExpansionKeyName="$SchemaName$AppSetupJava"
		ExpansionFileName="$SchemaName$AppSetup.java">
// Description: Java 25 Main for testing the $SchemaName$ schema database creation

$MssSourceLicense$

package $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup;

import java.lang.reflect.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.net.*;
import java.nio.file.Files;
import java.nio.file.StandardCopyOption;
import java.rmi.*;
import java.sql.*;
import java.text.*;
import java.util.*;
import java.util.concurrent.atomic.AtomicReference;

import javafx.application.Application;

import ch.qos.logback.classic.LoggerContext;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.text.StringEscapeUtils;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.core.env.ConfigurableEnvironment;

import server.markhome.mcf.v3_1.cflib.*;
import server.markhome.mcf.v3_1.cflib.inz.Inz;
import server.markhome.mcf.v3_1.cflib.inz.InzPathEntry;
import server.markhome.mcf.v3_1.cflib.dbutil.*;$iterate SchemaRefs( each importJavaPackageSchemaName empty empty )$
import $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.*;$iterate SchemaRefs( each importJavaPackageSchemaNameBuff empty empty )$
import $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.buff.*;
import $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup.fx.$SchemaName$AppSetupFxApplication;
$AppSetupClassBody$
</GenFile>

<GenRule GenDef="SchemaDef" Name="AppSetupClassBody">
@SpringBootApplication
@ComponentScan(basePackages = {
    "$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup.fx",   // if you have service beans here
    "$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup.spring"   // if you have service beans here
})
@EnableAutoConfiguration(exclude = {
})
public class $SchemaName$AppSetup
{
    private static final AtomicReference&lt;Properties&gt; systemProperties = new AtomicReference&lt;&gt;(null);
    private static final AtomicReference&lt;Properties&gt; applicationProperties = new AtomicReference&lt;&gt;(null);
    private static final AtomicReference&lt;Properties&gt; userDefaultProperties = new AtomicReference&lt;&gt;(null);
    private static final AtomicReference&lt;Properties&gt; userProperties = new AtomicReference&lt;&gt;(null);
    private static final AtomicReference&lt;Properties&gt; mergedProperties = new AtomicReference&lt;&gt;(null);

	public static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger($reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup.$SchemaName$AppSetup.class.getName());
	public static LoggerContext loggerContext = (LoggerContext) org.slf4j.LoggerFactory.getILoggerFactory();
	public static String startingupMessage = $SchemaName$AppSetup.class.getName() + " starting.";
$AppSetupClassBodyPart1$
</GenRule>

<GenRule GenDef="SchemaDef" Name="AppSetupClassBodyPart1">
    /**
     * Loads the application properties file from the application resources.
     */
    public static Properties getApplicationProperties() {
        if (applicationProperties.get() == null) {
            Properties props = new Properties();
            try (var in = $SchemaName$AppSetup.class.getClassLoader().getResourceAsStream("application.properties")) {
                if (in != null) {
                    props.load(in);
                } else {
                    throw new RuntimeException(Inz.x("$reference ManufacturingSchema lower SchemaName$appsetup.ApplicationPropertiesNotFound"));
                }
            } catch (IOException e) {
                throw new RuntimeException(Inz.x("$reference ManufacturingSchema lower SchemaName$appsetup.CouldNotLoadApplicationProperties"), e);
            }
            applicationProperties.compareAndSet(null, props);
        }
        return applicationProperties.get();
    }
$AppSetupClassBodyPart2$</GenRule>

<GenRule GenDef="SchemaDef" Name="AppSetupClassBodyPart2">
    /**
     * Loads the system properties, which hopefully haven't had the merge applied yet.
     */
    public static Properties getSystemProperties() {
        if (systemProperties.get() == null) {
            Properties props = new Properties();
            props.putAll(System.getProperties());
            systemProperties.compareAndSet(null, props);
        }
        return systemProperties.get();
    }
  
    /**
     * Loads the user default properties file from the application resources.
     */
    public static Properties getUserDefaultProperties() {
        if (userDefaultProperties.get() == null) {
            Properties props = new Properties();
            try (var in = $SchemaName$AppSetup.class.getClassLoader().getResourceAsStream("user-default.properties")) {
                if (in != null) {
                    props.load(in);
                } else {
                    throw new RuntimeException(Inz.x("$reference ManufacturingSchema lower SchemaName$appsetup.UserDefaultPropertiesNotFound"));
                }
            } catch (IOException e) {
                throw new RuntimeException(Inz.x("$reference ManufacturingSchema lower SchemaName$appsetup.FailedToLoadUserDefaultProperties"), e);
            }
            userDefaultProperties.compareAndSet(null, props);
        }
        return userDefaultProperties.get();
    }
$AppSetupClassBodyPart3$</GenRule>

<GenRule GenDef="SchemaDef" Name="AppSetupClassBodyPart3">
    /**
     * Make sure the user properties file doesn't exist yet
     */
    public static Properties getUserProperties() {
        if (userProperties.get() == null) {
            Properties props = new Properties();
            File userFile = new File(System.getProperty("user.home"), ".$reference ManufacturingSchema lower SchemaName$appsrv.properties");
            if (userFile.exists()) {
				throw new CFLibUsageException($SchemaName$AppSetup.class,
					"getUserProperties",
					String.format("%1$s already exists - application initialization previously completed", userFile.getPath()),
					String.format("%1$s already exists - application initialization previously completed", userFile.getPath()));
                <!--exit(0);-->
			}
			userProperties.compareAndSet(null, props);
        }
        return userProperties.get();
    }

    /**
     * Merges the System and User properties, giving preference to the User properties.
     */
    public static Properties getMergedProperties() {
        if (mergedProperties.get() == null) {
            Properties merged = new Properties();
            merged.putAll(getApplicationProperties());
            merged.putAll(getUserDefaultProperties());
            merged.putAll(getSystemProperties());
            merged.putAll(getUserProperties());
            mergedProperties.compareAndSet(null, merged);
        }
        return mergedProperties.get();
    }
$AppSetupClassBodyPart4$</GenRule>

<GenRule GenDef="SchemaDef" Name="AppSetupClassBodyPart4">
    public static void main(String[] args) {
        Inz.addPathEntry(new InzPathEntry("/opt/mcf/v3_1/java" + "/$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup/src/main/resources/" + "/$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$appsetup".replace(".","/") + "/langs"));

        // This weird looking cadence ensures that all the sub-property lists are prepared before getMergedProperties() is invoked, ensuring that any errors and exceptions along the way are thrown first and in predictable order
        Properties mergedProperties = getApplicationProperties();
        mergedProperties = getUserDefaultProperties();
        mergedProperties = getSystemProperties();
        mergedProperties = getUserProperties();
        mergedProperties = getMergedProperties();
        System.getProperties().putAll(mergedProperties);

        SpringApplication app = new SpringApplication($SchemaName$AppSetup.class);
        app.addInitializers((applicationContext) -&gt; {
            ConfigurableEnvironment env = applicationContext.getEnvironment();
            env.getPropertySources().addLast(new org.springframework.core.env.PropertiesPropertySource("userProperties", userProperties.get()));
        });
		int finalvalue = 0xf00000;$iterate SchemaRefs( each AppSetupWireBuffSchema empty empty )$$AppSetupWireBuffSchema$
		logStartupInfo(args);
		logger.info("Runtime class codes are " + 0xf00000 + ".." + (finalvalue-1) + " (" + (finalvalue-0xf00000-1) + " tables in total)");
        Application.launch($SchemaName$AppSetupFxApplication.class, args);
    }

	public static void logStartupInfo(String[] args) {
		logger.info(startingupMessage);
		String argsString = "";
		if (args != null &amp;&amp; args.length &gt; 0) {
			StringBuilder sb = new StringBuilder(argsString);
			for (int i = 0; i &lt; args.length; i++) {
				sb.append("arg ").append(i).append(" = &gt;&gt;&gt;").append(args[i]).append("&lt;&lt;&lt;");
			}
			argsString = sb.toString();
		}
		String message = "Spring boot Application args &gt;&gt;&gt;" + argsString + "&lt;&lt;&lt;";
		logger.info("The $SchemaName$ Application Setup is starting with args &gt;&gt;&gt;{}&lt;&lt;&lt;", message);
		String currentDirectory = new File(".").getAbsolutePath();
		message = "Application current Directory is: &gt;&gt;&gt;" + currentDirectory + "&lt;&lt;&lt;";
		logger.info(message);
	}

}
</GenRule>

<GenRule GenDef="SchemaRef" Name="AppSetupWireBuffSchema">$reference RefSchema AppSetupWireBuffSchema$</GenRule>
<GenRule GenDef="SchemaDef" Name="AppSetupWireBuffSchema">
		$SchemaName$BuffSchema buff$SchemaName$ = new $SchemaName$BuffSchema();
		finalvalue = buff$SchemaName$.initClassMapEntries(finalvalue);
		buff$SchemaName$.set$SchemaName$Schema(buff$SchemaName$);</GenRule>
		
<GenRule GenDef="SchemaRef" Name="emitAppSetupComponentScanProjectBuffComma">$emitAppSetupComponentScanProjectBuff$,</GenRule>
<GenRule GenDef="SchemaRef" Name="emitAppSetupComponentScanProjectBuff">$reference RefSchema emitAppSetupComponentScanProjectBuff$</GenRule>

<GenRule GenDef="SchemaDef" Name="emitAppSetupComponentScanProjectBuffComma">$emitAppSetupComponentScanProjectBuff$,</GenRule>
<GenRule GenDef="SchemaDef" Name="emitAppSetupComponentScanProjectBuff">
    "$lower DefTopProjectName$.$lower DefVUnderVersion$.$lower DefSubProjectName$.$lower DefSchemaName$.buff"</GenRule>

</RuleSet>
