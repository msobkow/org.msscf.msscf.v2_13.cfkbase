<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Mark's Code Fractal CFKBase 3.1 Code Fractal Knowledge Base
 *
 *	Copyright 2016-2026 Mark Stephen Sobkow
 *
 *	This file is part of Mark's Code Fractal CFKBase.
 *
 *	Mark's Code Fractal CFKBase is available under dual commercial license from
 *	Mark Stephen Sobkow, or under the terms of the GNU General Public License,
 *	Version 3 or later.
 *
 *	Mark's Code Fractal CFKBase is free software: you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	Mark's Code Fractal CFKBase is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Mark's Code Fractal CFKBase.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 *
 *	If you wish to modify and use this code without publishing your changes,
 *	or integrate it with proprietary code, please contact Mark Stephen Sobkow
 *	for a commercial license at mark.sobkow@gmail.com
 * -->
<RuleSet
	xmlns="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xsi:schemaLocation="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	ToolSet="java"
	Name="src/schema/jpa/SchemaJpaSchema.java"
	Revision="3.0"
	Descr="Java 25 JPA implementation of a $SchemaName$ schema.">

	<GenFile GenDef="SchemaDef" Name="fileSchemaJpaSchemaJava"
			GenerateOnce="false"
		ModuleName="$reference ManufacturingSchema lower JavaPackage$"
		SourceBundle="java"
		BasePackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$jpa/src/main/java"
		SubPackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa"
		ExpansionClassName="$SchemaName$JpaSchemaJava"
		ExpansionKeyName="$SchemaName$JpaSchemaJava"
		ExpansionFileName="$SchemaName$JpaSchema.java"
>// Description: Java 25 JPA implementation of a $SchemaName$ schema.

$MssSourceLicense$

package $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa;
//package $lower DefTopProjectName$.$DefVUnderVersion$.$lower DefSubProjectName$.$lower MfgSchemaName$.jpa;

import java.io.Serializable;
import java.math.*;
import java.time.*;
import java.net.InetAddress;
import java.util.*;
import jakarta.persistence.*;
import jakarta.transaction.Transactional;
import org.apache.commons.codec.binary.Base64;
import org.apache.commons.text.StringEscapeUtils;
import org.springframework.beans.factory.annotation.Autowired;$importsForApplicationContextAware$
import io.github.msobkow.v3_1.cflib.*;
import io.github.msobkow.v3_1.cflib.dbutil.*;
import io.github.msobkow.v3_1.cflib.inz.Inz;
import io.github.msobkow.v3_1.cflib.xml.CFLibXmlUtil;$poptop SchemaDef iterate SchemaRefs( each importJavaPackageSchemaName empty empty )$
import $reference ManufacturingSchema lower JavaPackage$.$lower reference ManufacturingSchema SchemaName$.*;$poptop SchemaDef iterate SchemaRefs( each importJavaPackageSchemaNameJpa empty empty )$
import $reference ManufacturingSchema lower JavaPackage$.$lower reference ManufacturingSchema SchemaName$jpahooks.$DefSchemaName$JpaHooksSchema;

public class $SchemaName$JpaSchema
	implements I$SchemaName$Schema$iterate SchemaRefs( each commaNewlineSchemaSchemaImplementsInterface empty empty )$
{
	private $DefSchemaName$JpaHooksSchema $lower DefSchemaName$JpaHooksSchema = null;
$iterate SchemaRefs( each empty empty declTablePerms )$
$iterate SchemaTables( each declJpaSchemaTableTableMember )$
$iterate SchemaTables( each declJpaSchemaTableFactoryMember )$
$implJpaSchemaClassMapInitializers$$implSchemaGetJpaHooksSchema$$implSchemaGetSchemaService$
$implJpaSchemaMoreMethods$$implJpaSchemaTablePermsAccessors$<!--$implJpaSchemaXmlEncodeString$-->$implSchemaBootstrap$}
</GenFile>

<GenRule GenDef="SchemaDef" Name="implSchemaGetSchemaService">
	public $DefSchemaName$JpaSchemaService getSchemaService() {
		return( getJpaHooksSchema().getSchemaService() );
	}</GenRule>

<GenRule GenDef="SchemaDef" Name="implSchemaGetJpaHooksSchema">
	public $DefSchemaName$JpaHooksSchema getJpaHooksSchema() {
		final String S_ProcName = "getJpaHooksSchema";
		final String S_BeanClassName = "$DefSchemaName$JpaHooksSchema";
		final String S_BeanName = "$lower DefDbSchemaName$JpaHooksSchema";
		final String S_MemberName = "$lower DefSchemaName$JpaHooksSchema";
		if ( $lower DefSchemaName$JpaHooksSchema == null ) {
			ApplicationContext ctx = I$DefSchemaName$Schema.getApplicationContext();
			if (ctx == null) {
				throw new CFLibNullArgumentException(getClass(), S_ProcName, 0, "I$DefSchemaName$Schema.getApplicationContext()");
			}
			try {
				if (!ctx.isTypeMatch(S_BeanName, $DefSchemaName$JpaHooksSchema.class)) {
					throw new CFLibInvalidStateException(getClass(), S_ProcName,
						String.format(Inz.s("cflib.common.ACBeanTypeFailure"), S_BeanName, S_BeanClassName),
						String.format(Inz.x("cflib.common.ACBeanTypeFailure"), S_BeanName, S_BeanClassName));
				}
				$lower DefSchemaName$JpaHooksSchema = ($DefSchemaName$JpaHooksSchema)(ctx.getBean(S_BeanName, $DefSchemaName$JpaHooksSchema.class));
				if ($lower DefSchemaName$JpaHooksSchema == null) {
					// Need to manually construct and register instance; the plumbing is presumed to happen automagically via createBean()
					$lower DefSchemaName$JpaHooksSchema = ($DefSchemaName$JpaHooksSchema)(ctx.getAutowireCapableBeanFactory().createBean($DefSchemaName$JpaHooksSchema.class));
					if ($lower DefSchemaName$JpaHooksSchema == null) {
						throw new CFLibInvalidStateException( getClass(), S_ProcName,
							String.format(Inz.s("cflib.common.ACAutowireBeanInstanceCreationFailure"),	S_BeanClassName),
							 String.format(Inz.x("cflib.common.ACAutowireBeanInstanceCreationFailure"), S_BeanClassName));
					}
				}
			}
			catch (BeansException ex) {
				$lower DefSchemaName$JpaHooksSchema = null;
				throw new CFLibInvalidStateException(getClass(), S_ProcName, 
					String.format(Inz.s("cflib.common.CaughtWhileTryingToResolve"), ex.getClass().getName(), S_BeanClassName, S_MemberName, ex.getMessage()),
					String.format(Inz.x("cflib.common.CaughtWhileTryingToResolve"), ex.getClass().getName(), S_BeanClassName, S_MemberName, ex.getLocalizedMessage()),
					ex);
			}
		}
		return( $lower DefSchemaName$JpaHooksSchema );
	}
</GenRule>

<GenRule GenDef="SchemaDef" Name="implSchemaBootstrap">
	public void bootstrapSchema() {
		getSchemaService().bootstrapSchema();
	}
</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaClassMapInitializers">
	@Override
	public int initClassMapEntries(int value) {
		return( I$SchemaName$Schema.doInitClassMapEntries(value) );
	}

	@Override
	public void wireRecConstructors() {
		I$SecSchemaName$Schema.ClassMapEntry entry;$iterate Tables( each maybeWireJpaSchemaClassMapRecConstructor empty empty)$
	}

	@Override
	public void wireTableTableInstances() {$iterate Tables( each maybeWireJpaSchemaTableTableInstance empty empty )$
	}
$iterate SchemaRefs( each implJpaSchemaGetSchemaNameSchema empty empty )$$implJpaSchemaGetSchemaNameSchema$</GenRule>

	<GenRule GenDef="Table" Name="maybeWireJpaSchemaTableTableInstance">$switch HasDefSchema yes empty default wireJpaSchemaTableTableInstance$</GenRule>
	<GenRule GenDef="Table" Name="wireJpaSchemaTableTableInstance">
		if (table$TableName$ == null || !(table$TableName$ instanceof $DefSchemaName$Jpa$TableName$Table)) {
			table$TableName$ = new $DefSchemaName$Jpa$TableName$Table(this);
		}</GenRule>

	<GenRule GenDef="SchemaRef" Name="implJpaSchemaGetSchemaNameSchema">$reference RefSchema implJpaSchemaGetSchemaNameSchema$</GenRule>
	<GenRule GenDef="SchemaDef" Name="implJpaSchemaGetSchemaNameSchema">
	@Override		
	public I$SchemaName$Schema get$SchemaName$Schema() {
		return( I$SchemaName$Schema.getBacking$SchemaName$() );
	}

	@Override
	public void set$SchemaName$Schema(I$SchemaName$Schema schema) {
		I$SchemaName$Schema.setBacking$SchemaName$(schema);
		schema.wireRecConstructors();
	}
</GenRule>

	<GenRule GenDef="Table" Name="maybeWireJpaSchemaClassMapRecConstructor">$switch HasDefSchema yes empty default wireJpaSchemaClassMapRecConstructor$</GenRule>
	<GenRule GenDef="Table" Name="wireJpaSchemaClassMapRecConstructor">
		entry = I$SchemaName$Schema.getClassMapByBackingClassCode(I$DefSchemaName$$TableName$.CLASS_CODE);
		if (entry != null) {
			entry.setBackingRecConstructor( new BackingRecConstructor() {
				@Override
				public Object instantiate() {
					I$DefSchemaName$$TableName$ ret = new $DefSchemaName$Jpa$TableName$();
					return(ret);
				}
			});
		}
		else {
			throw new CFLibNullArgumentException($SchemaName$JpaSchema.class, "wireRecConstructors", 0, "I$SchemaName$Schema.getClassMapByBackingClassCode(I$DefSchemaName$$TableName$.CLASS_CODE)[" + I$DefSchemaName$$TableName$.CLASS_CODE + "]");
		}
	</GenRule>

	<GenRule GenDef="SchemaRef" Name="commaNewlineSchemaSchemaImplementsInterface">,
		I$reference RefSchema SchemaName$Schema</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaMoreMethods"
		>$implJpaSchemaSchemaConstructor$$iterate SchemaRefs( first implJpaSchemaNewSchema each empty empty implJpaSchemaNewSchema )$$iterate Id16Generators( each implNextIdGen empty empty)$$iterate Id32Generators( each implNextIdGen empty empty)$$iterate Id64Generators( each implNextIdGen empty empty)$$iterate DbKeyHash128Generators( each implNextIdGen empty empty )$$iterate DbKeyHash160Generators( each implNextIdGen empty empty )$$iterate DbKeyHash224Generators( each implNextIdGen empty empty )$$iterate DbKeyHash256Generators( each implNextIdGen empty empty )$$iterate DbKeyHash384Generators( each implNextIdGen empty empty )$$iterate DbKeyHash512Generators( each implNextIdGen empty empty )$$iterate UuidGenerators( each implNextIdGen empty empty )$$iterate Uuid6Generators( each implNextIdGen empty empty )$$iterate SchemaTables( each implJpaTableMethods empty empty )$</GenRule>

	<GenRule ScopeDef="SchemaDef" GenDef="Id16Gen" Name="implNextIdGen">
	@Override
	public short next$Name$() {
		throw new CFLibNotImplementedYetException( getClass(), "next$Name$" );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="Id32Gen" Name="implNextIdGen">
	@Override
	public int next$Name$() {
		throw new CFLibNotImplementedYetException( getClass(), "next$Name$" );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="Id64Gen" Name="implNextIdGen">
	@Override
	public long next$Name$() {
		throw new CFLibNotImplementedYetException( getClass(), "next$Name$" );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash128Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash128 next$Name$() {
		CFLibDbKeyHash128 retval = new CFLibDbKeyHash128(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash160Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash160 next$Name$() {
		CFLibDbKeyHash160 retval = new CFLibDbKeyHash160(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash224Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash224 next$Name$() {
		CFLibDbKeyHash224 retval = new CFLibDbKeyHash224(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash256Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash256 next$Name$() {
		CFLibDbKeyHash256 retval = new CFLibDbKeyHash256(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash384Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash384 next$Name$() {
		CFLibDbKeyHash384 retval = new CFLibDbKeyHash384(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="DbKeyHash512Gen" Name="implNextIdGen">
	@Override
	public CFLibDbKeyHash512 next$Name$() {
		CFLibDbKeyHash512 retval = new CFLibDbKeyHash512(0);
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="UuidGen" Name="implNextIdGen">
	@Override
	public UUID next$Name$() {
		UUID retval = UUID.randomUUID();
		return( retval );
	}
</GenRule>
	<GenRule ScopeDef="SchemaDef" GenDef="Uuid6Gen" Name="implNextIdGen">
	@Override
	public CFLibUuid6 next$Name$() {
		CFLibUuid6 retval = CFLibUuid6.generate();
		return( retval );
	}
</GenRule>

	<GenRule GenDef="Table" Name="declJpaSchemaTableTableMember"
>	protected I$DefSchemaName$$TableName$Table table$TableName$;
</GenRule>

	<GenRule GenDef="Table" Name="declJpaSchemaTableFactoryMember"
>	protected I$DefSchemaName$$TableName$Factory factory$TableName$;
</GenRule>

	<GenRule GenDef="Table" Name="implJpaTableMethods">
	public I$DefSchemaName$$TableName$Table getTable$TableName$() {
		return( table$TableName$ );
	}

	public void setTable$TableName$( I$DefSchemaName$$TableName$Table value ) {
		table$TableName$ = value;
	}

	public I$DefSchemaName$$TableName$Factory getFactory$TableName$() {
		return( factory$TableName$ );
	}

	public void setFactory$TableName$( I$DefSchemaName$$TableName$Factory value ) {
		factory$TableName$ = value;
	}
</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaTablePermsAccessors">
	/**
	 *	Get the Table Permissions interface for the schema.
	 *
	 *	@return	The Table Permissions interface for the schema.
	 *
	 *	@throws CFLibNotSupportedException thrown by client-side implementations.
	 */
	public static I$SecSchemaName$TablePerms getTablePerms() {
		return($poptop SchemaDef iterate SchemaRefs(first implJpaReturnThisSchemaRefGetTablePerms each empty empty implJpaReturnLocalGetTablePerms)$);
	}

	/**
	 *	Get the Table Permissions interface cast to this schema's implementation.
	 *
	 *	@return The Table Permissions interface for this schema.
	 */
	public static I$SchemaName$TablePerms get$SchemaName$TablePerms() {
		return (I$SchemaName$TablePerms)getTablePerms();
	}

	/**
	 *	Set the Table Permissions interface for the schema.  All fractal subclasses of
	 *	the I$SecSchemaName$TablePerms implement at least that interface plus their own
	 *	accessors.
	 *
	 *	@param	value	The Table Permissions interface to be used by the schema.
	 *
	 *	@throws CFLibNotSupportedException thrown by client-side implementations.
	 */
	public static void setTablePerms( I$SecSchemaName$TablePerms value ) {$poptop SchemaDef iterate SchemaRefs(first implJpaThisSchemaRefSetTablePerms each empty empty implJpaLocalSetTablePerms)$
	}
</GenRule>

	<GenRule GenDef="SchemaRef" Name="implJpaReturnThisSchemaRefGetTablePerms">$reference RefSchema SchemaName$JpaSchema.getTablePerms()</GenRule>

	<GenRule GenDef="SchemaRef" Name="implJpaThisSchemaRefSetTablePerms">
		$reference RefSchema SchemaName$JpaSchema.setTablePerms(value);</GenRule>
	
	<GenRule GenDef="Object" Name="implJpaReturnLocalGetTablePerms">tablePerms</GenRule>
	<GenRule GenDef="Object" Name="implJpaLocalSetTablePerms">
		if(value == null) {
			throw new CFLibNullArgumentException($DefSchemaName$JpaSchema.class, "setTablePerms", 1, "value");
		}
		tablePerms = value;</GenRule>

	<GenRule GenDef="Table" Name="implJpaSchemaTableTableAccessors">
	public I$DefSchemaName$$TableName$Table getTable$TableName$() {
		return( table$TableName$ );
	}

	public void setTable$TableName$( I$DefSchemaName$$TableName$Table value ) {
		table$TableName$ = value;
	}
</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaSchemaConstructor">
	public $poptop SchemaDef SchemaName$JpaSchema() {
$poptop SchemaDef iterate SchemaTables( each initJpaSchemaTableTableMember )$
$poptop SchemaDef iterate SchemaTables( each initJpaSchemaTableFactoryMember )$	}
</GenRule>

	<GenRule GenDef="SchemaRef" Name="implJpaSchemaNewSchema"
		>$reference RefSchema implJpaSchemaNewSchema$</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaNewSchema">
	@Override
	public I$poptop SchemaDef SchemaName$Schema newSchema() {
		throw new CFLibMustOverrideException( getClass(), "newSchema" );
	}
</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaNewSchema">
	@Override
	public I$poptop SchemaDef SchemaName$Schema newSchema() {
		throw new CFLibMustOverrideException( getClass(), "newSchema" );
	}
</GenRule>

	<GenRule GenDef="Table" Name="initJpaSchemaTableTableMember">
		table$TableName$ = null;</GenRule>

	<GenRule GenDef="Table" Name="initJpaSchemaTableFactoryMember">
		factory$TableName$ = new $DefSchemaName$Jpa$TableName$DefaultFactory();</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaXmlEncodeString">
	public static String xmlEncodeString( String val ) {
		StringBuffer buff = new StringBuffer();
		int len = val.length();
		for( int idx = 0; idx &lt; len; idx ++ ) {
			char c = val.charAt( idx );
			switch( c ) {
				case '&amp;':
					buff.append( "&amp;amp;" );
					break;
				case '&lt;':
					buff.append( "&amp;lt;" );
					break;
				case '&gt;':
					buff.append( "&amp;gt;" );
					break;
				case '"':
					buff.append( "&amp;quot;" );
					break;
				case '\\'':
					buff.append( "&amp;apos;" );
					break;
				default:
					buff.append( c );
					break;
			}
		}
		return( buff.toString() );
	}
</GenRule>

</RuleSet>
