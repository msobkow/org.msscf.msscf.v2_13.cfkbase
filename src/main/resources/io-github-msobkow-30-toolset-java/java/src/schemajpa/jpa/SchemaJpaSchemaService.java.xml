<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Mark's Code Fractal CFKBase 3.1 Code Fractal Knowledge Base
 *
 *	Copyright 2016-2026 Mark Stephen Sobkow
 *
 *	This file is part of Mark's Code Fractal CFKBase.
 *
 *	Mark's Code Fractal CFKBase is available under dual commercial license from
 *	Mark Stephen Sobkow, or under the terms of the GNU General Public License,
 *	Version 3 or later.
 *
 *	Mark's Code Fractal CFKBase is free software: you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	Mark's Code Fractal CFKBase is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Mark's Code Fractal CFKBase.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 *
 *	If you wish to modify and use this code without publishing your changes,
 *	or integrate it with proprietary code, please contact Mark Stephen Sobkow
 *	for a commercial license at mark.sobkow@gmail.com
 * -->
<RuleSet
	xmlns="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xsi:schemaLocation="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	ToolSet="java"
	Name="src/Schema/jpa/SchemaJpaSchemaService.java"
	Revision="3.0"
	Descr="Java 25 Spring JPA Service for Schema">

	<GenFile GenDef="SchemaDef" Name="fileSchemaJpaSchemaServiceJava"
			GenerateOnce="false"
		ModuleName="$reference ManufacturingSchema lower JavaPackage$.jpa"
		SourceBundle="java"
		BasePackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$jpa/src/main/java"
		SubPackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa"
		ExpansionClassName="$SchemaName$JpaSchemaServiceJava"
		ExpansionKeyName="$SchemaName$JpaSchemaServiceJava"
		ExpansionFileName="$SchemaName$JpaSchemaService.java"
>// Description: Java 25 Spring JPA Service for $SchemaName$

$MssSourceLicense$

package $lower DefTopProjectName$.$DefVUnderVersion$.$lower DefSubProjectName$.$lower DefSchemaName$.jpa;

import java.io.Serializable;
import java.math.*;
import java.net.InetAddress;
import java.time.*;
import java.util.*;
import jakarta.persistence.*;
import io.github.msobkow.v3_1.cflib.*;
import io.github.msobkow.v3_1.cflib.dbutil.*;
import io.github.msobkow.v3_1.cflib.xml.CFLibXmlUtil;
import org.apache.commons.codec.binary.Base64;
import org.apache.commons.text.StringEscapeUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;$poptop SchemaDef iterate SchemaRefs( each importJavaPackageSchemaName empty empty )$
import $lower DefTopProjectName$.$DefVUnderVersion$.$lower DefSubProjectName$.$lower DefSchemaName$.*;

/**
 *	Services for schema $SchemaName$ defined in $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa
 *	using the $SchemaName$*Repository objects to access the data directly, bypassing normal application security for the bootstrap and login processing.
 */
@Service("$lower DefDbSchemaName$JpaSchemaService")
public class $SchemaName$JpaSchemaService {

	@Autowired
	@Qualifier("$lower DefDbSchemaName$EntityManagerFactory")
	private LocalContainerEntityManagerFactoryBean $lower DefDbSchemaName$EntityManagerFactory;$iterate Tables( each JpaSchemaServiceMaybeAutowireService empty empty )$
$JpaSchemaServiceBootstrap$
}
</GenFile>

	<GenRule GenDef="Table" Name="JpaSchemaServiceMaybeAutowireService">$switch HasDefSchema yes empty default JpaSchemaServiceAutowireService$</GenRule>
	<GenRule GenDef="Table" Name="JpaSchemaServiceAutowireService">
	@Autowired
	private $DefSchemaName$Jpa$TableName$Service $lower TableName$Service;
</GenRule>

	<GenRule GenDef="SchemaDef" Name="JpaSchemaServiceBootstrap">
	public void bootstrapSchema() {$iterate SchemaRefs( each invokeJpaSchemaServiceBootstrapReferenced empty empty )$$iterate SchemaRefs( empty invokeJpaSchemaServiceBootstrapSecurity each empty )$
		bootstrapAllTablesSecurity();
	}
$iterate SchemaRefs( empty implJpaSchemaServiceBootstrapSecurity each empty )$$implJpaSchemaServiceBootstrapAllTablesSecurity$$implJpaSchemaServiceBootstrapTableSecurity$
</GenRule>

	<GenRule GenDef="SchemaRef" Name="invokeJpaSchemaServiceBootstrapReferenced">$reference RefSchema invokeJpaSchemaServiceBootstrapReferenced$</GenRule>
	<GenRule GenDef="SchemaDef" Name="invokeJpaSchemaServiceBootstrapReferenced">
		I$SchemaName$Schema.getBacking$SchemaName$().bootstrapSchema();</GenRule>
	<GenRule GenDef="Object" Name="invokeJpaSchemaServiceBootstrapSecurity">
		bootstrapSecurity();</GenRule>

	<GenRule GenDef="SchemaDef" Name="implJpaSchemaServiceBootstrapTableSecurity">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower SecDbSchemaName$TransactionManager")
	public void bootstrapTableSecurity(I$SecSchemaName$Authorization auth, String tableName, boolean hasHistory, boolean isMutable) {
		LocalDateTime now = LocalDateTime.now();
		String lowerTableName = tableName.toLowerCase();
		String createPermName = "create" + lowerTableName;
		String readPermName = "read" + lowerTableName;
		String updatePermName = "update" + lowerTableName;
		String deletePermName = "delete" + lowerTableName;
		String restorePermName = "restore" + lowerTableName;
		String mutatePermName = "mutate" + lowerTableName;
		I$SecSchemaName$SecGroup secGroupCreate;
		CFLibDbKeyHash256 secGroupCreateID;
		I$SecSchemaName$SecGrpMemb secGroupCreateMembSysadmin;
		CFLibDbKeyHash256 secGroupCreateMembSysadminID;
		I$SecSchemaName$SecGroup secGroupRead;
		CFLibDbKeyHash256 secGroupReadID;
		I$SecSchemaName$SecGrpMemb secGroupReadMembSysadmin;
		CFLibDbKeyHash256 secGroupReadMembSysadminID;
		I$SecSchemaName$SecGroup secGroupUpdate;
		CFLibDbKeyHash256 secGroupUpdateID;
		I$SecSchemaName$SecGrpMemb secGroupUpdateMembSysadmin;
		CFLibDbKeyHash256 secGroupUpdateMembSysadminID;
		I$SecSchemaName$SecGroup secGroupDelete;
		CFLibDbKeyHash256 secGroupDeleteID;
		I$SecSchemaName$SecGrpMemb secGroupDeleteMembSysadmin;
		CFLibDbKeyHash256 secGroupDeleteMembSysadminID;
		I$SecSchemaName$SecGroup secGroupRestore;
		CFLibDbKeyHash256 secGroupRestoreID;
		I$SecSchemaName$SecGrpMemb secGroupRestoreMembSysadmin;
		CFLibDbKeyHash256 secGroupRestoreMembSysadminID;
		I$SecSchemaName$SecGroup secGroupMutate;
		CFLibDbKeyHash256 secGroupMutateID;
		I$SecSchemaName$SecGrpMemb secGroupMutateMembSysadmin;
		CFLibDbKeyHash256 secGroupMutateMembSysadminID;

		secGroupCreate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), createPermName);
		if (secGroupCreate != null) {
			secGroupCreateID = secGroupCreate.getRequiredSecGroupId();
			secGroupCreateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupCreateID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupCreateMembSysadmin != null) {
				secGroupCreateMembSysadminID = secGroupCreateMembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupCreateMembSysadminID = null;
			}
		}
		else {
			secGroupCreateID = null;
			secGroupCreateMembSysadmin = null;
			secGroupCreateMembSysadminID = null;
		}

		secGroupRead = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), readPermName);
		if (secGroupRead != null) {
			secGroupReadID = secGroupRead.getRequiredSecGroupId();
			secGroupReadMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupReadID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupReadMembSysadmin != null) {
				secGroupReadMembSysadminID = secGroupReadMembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupReadMembSysadminID = null;
			}
		}
		else {
			secGroupReadID = null;
			secGroupReadMembSysadmin = null;
			secGroupReadMembSysadminID = null;
		}

		secGroupUpdate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), updatePermName);
		if (secGroupUpdate != null) {
			secGroupUpdateID = secGroupUpdate.getRequiredSecGroupId();
			secGroupUpdateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupUpdateID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupUpdateMembSysadmin != null) {
				secGroupUpdateMembSysadminID = secGroupUpdateMembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupUpdateMembSysadminID = null;
			}
		}
		else {
			secGroupUpdateID = null;
			secGroupUpdateMembSysadmin = null;
			secGroupUpdateMembSysadminID = null;
		}

		secGroupDelete = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), deletePermName);
		if (secGroupDelete != null) {
			secGroupDeleteID = secGroupDelete.getRequiredSecGroupId();
			secGroupDeleteMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupDeleteID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupDeleteMembSysadmin != null) {
				secGroupDeleteMembSysadminID = secGroupDeleteMembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupDeleteMembSysadminID = null;
			}
		}
		else {
			secGroupDeleteID = null;
			secGroupDeleteMembSysadmin = null;
			secGroupDeleteMembSysadminID = null;
		}

		if (hasHistory) {
			secGroupRestore = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), restorePermName);
			if (secGroupRestore != null) {
				secGroupRestoreID = secGroupRestore.getRequiredSecGroupId();
				secGroupRestoreMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupRestoreID, I$SecSchemaName$Schema.getSysAdminId());
				if (secGroupRestoreMembSysadmin != null) {
					secGroupRestoreMembSysadminID = secGroupRestoreMembSysadmin.getRequiredSecGrpMembId();
				}
				else {
					secGroupRestoreMembSysadminID = null;
				}
			}
			else {
				secGroupRestoreID = null;
				secGroupRestoreMembSysadmin = null;
				secGroupRestoreMembSysadminID = null;
			}
		}
		else {
			secGroupRestore = null;
			secGroupRestoreID = null;
			secGroupRestoreMembSysadmin = null;
			secGroupRestoreMembSysadminID = null;
		}

		if (isMutable) {
			secGroupMutate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), mutatePermName);
			if (secGroupMutate != null) {
				secGroupMutateID = secGroupMutate.getRequiredSecGroupId();
				secGroupMutateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupMutateID, I$SecSchemaName$Schema.getSysAdminId());
				if (secGroupMutateMembSysadmin != null) {
					secGroupMutateMembSysadminID = secGroupMutateMembSysadmin.getRequiredSecGrpMembId();
				}
				else {
					secGroupMutateMembSysadminID = null;
				}
			}
			else {
				secGroupMutateID = null;
				secGroupMutateMembSysadmin = null;
				secGroupMutateMembSysadminID = null;
			}
		}
		else {
			secGroupMutate = null;
			secGroupMutateID = null;
			secGroupMutateMembSysadmin = null;
			secGroupMutateMembSysadminID = null;
		}
		
		if (secGroupCreateID == null || secGroupCreateID.isNull()) {
			secGroupCreateID = new CFLibDbKeyHash256(0);
		}
		if (secGroupCreateMembSysadminID == null || secGroupCreateMembSysadminID.isNull()) {
			secGroupCreateMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupReadID == null || secGroupReadID.isNull()) {
			secGroupReadID = new CFLibDbKeyHash256(0);
		}
		if (secGroupReadMembSysadminID == null || secGroupReadMembSysadminID.isNull()) {
			secGroupReadMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupUpdateID == null || secGroupUpdateID.isNull()) {
			secGroupUpdateID = new CFLibDbKeyHash256(0);
		}
		if (secGroupUpdateMembSysadminID == null || secGroupUpdateMembSysadminID.isNull()) {
			secGroupUpdateMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupDeleteID == null || secGroupDeleteID.isNull()) {
			secGroupDeleteID = new CFLibDbKeyHash256(0);
		}
		if (secGroupDeleteMembSysadminID == null || secGroupDeleteMembSysadminID.isNull()) {
			secGroupDeleteMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (hasHistory) {
			if (secGroupRestoreID == null || secGroupRestoreID.isNull()) {
				secGroupRestoreID = new CFLibDbKeyHash256(0);
			}
			if (secGroupRestoreMembSysadminID == null || secGroupRestoreMembSysadminID.isNull()) {
				secGroupRestoreMembSysadminID = new CFLibDbKeyHash256(0);
			}
		}
		if (isMutable) {
			if (secGroupMutateID == null || secGroupMutateID.isNull()) {
				secGroupMutateID = new CFLibDbKeyHash256(0);
			}
			if (secGroupMutateMembSysadminID == null || secGroupMutateMembSysadminID.isNull()) {
				secGroupMutateMembSysadminID = new CFLibDbKeyHash256(0);
			}
		}

		if (secGroupCreate == null) {
			secGroupCreate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupCreate.setRequiredRevision(1);
			secGroupCreate.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupCreate.setRequiredName(createPermName);
			secGroupCreate.setRequiredIsVisible(true);
			secGroupCreate.setRequiredSecGroupId(secGroupCreateID);
			secGroupCreate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupCreate);
			secGroupCreateID = secGroupCreate.getRequiredSecGroupId();
		}

		if (secGroupCreateMembSysadmin == null) {
			secGroupCreateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupCreateMembSysadmin.setRequiredRevision(1);
			secGroupCreateMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupCreateMembSysadmin.setRequiredContainerGroup(secGroupCreateID);
			secGroupCreateMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupCreateMembSysadmin.setRequiredSecGrpMembId(secGroupCreateMembSysadminID);
			secGroupCreateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupCreateMembSysadmin);
			secGroupCreateMembSysadminID = secGroupCreateMembSysadmin.getRequiredSecGrpMembId();
		}

		if (secGroupRead == null) {
			secGroupRead = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupRead.setRequiredRevision(1);
			secGroupRead.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupRead.setRequiredName(readPermName);
			secGroupRead.setRequiredIsVisible(true);
			secGroupRead.setRequiredSecGroupId(secGroupReadID);
			secGroupRead = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupRead);
			secGroupReadID = secGroupRead.getRequiredSecGroupId();
		}

		if (secGroupReadMembSysadmin == null) {
			secGroupReadMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupReadMembSysadmin.setRequiredRevision(1);
			secGroupReadMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupReadMembSysadmin.setRequiredContainerGroup(secGroupReadID);
			secGroupReadMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupReadMembSysadmin.setRequiredSecGrpMembId(secGroupReadMembSysadminID);
			secGroupReadMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupReadMembSysadmin);
			secGroupReadMembSysadminID = secGroupReadMembSysadmin.getRequiredSecGrpMembId();
		}

		if (secGroupUpdate == null) {
			secGroupUpdate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupUpdate.setRequiredRevision(1);
			secGroupUpdate.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupUpdate.setRequiredName(updatePermName);
			secGroupUpdate.setRequiredIsVisible(true);
			secGroupUpdate.setRequiredSecGroupId(secGroupUpdateID);
			secGroupUpdate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupUpdate);
			secGroupUpdateID = secGroupUpdate.getRequiredSecGroupId();
		}

		if (secGroupUpdateMembSysadmin == null) {
			secGroupUpdateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupUpdateMembSysadmin.setRequiredRevision(1);
			secGroupUpdateMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupUpdateMembSysadmin.setRequiredContainerGroup(secGroupUpdateID);
			secGroupUpdateMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupUpdateMembSysadmin.setRequiredSecGrpMembId(secGroupUpdateMembSysadminID);
			secGroupUpdateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupUpdateMembSysadmin);
			secGroupUpdateMembSysadminID = secGroupUpdateMembSysadmin.getRequiredSecGrpMembId();
		}

		if (secGroupDelete == null) {
			secGroupDelete = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupDelete.setRequiredRevision(1);
			secGroupDelete.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupDelete.setRequiredName(deletePermName);
			secGroupDelete.setRequiredIsVisible(true);
			secGroupDelete.setRequiredSecGroupId(secGroupDeleteID);
			secGroupDelete = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupDelete);
			secGroupDeleteID = secGroupDelete.getRequiredSecGroupId();
		}

		if (secGroupDeleteMembSysadmin == null) {
			secGroupDeleteMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupDeleteMembSysadmin.setRequiredRevision(1);
			secGroupDeleteMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupDeleteMembSysadmin.setRequiredContainerGroup(secGroupDeleteID);
			secGroupDeleteMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupDeleteMembSysadmin.setRequiredSecGrpMembId(secGroupDeleteMembSysadminID);
			secGroupDeleteMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupDeleteMembSysadmin);
			secGroupDeleteMembSysadminID = secGroupDeleteMembSysadmin.getRequiredSecGrpMembId();
		}
		
		if (hasHistory) {
			if (secGroupRestore == null) {
				secGroupRestore = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
				secGroupRestore.setRequiredRevision(1);
				secGroupRestore.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
				secGroupRestore.setRequiredName(restorePermName);
				secGroupRestore.setRequiredIsVisible(true);
				secGroupRestore.setRequiredSecGroupId(secGroupRestoreID);
				secGroupRestore = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupRestore);
				secGroupRestoreID = secGroupRestore.getRequiredSecGroupId();
			}

			if (secGroupRestoreMembSysadmin == null) {
				secGroupRestoreMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
				secGroupRestoreMembSysadmin.setRequiredRevision(1);
				secGroupRestoreMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
				secGroupRestoreMembSysadmin.setRequiredContainerGroup(secGroupRestoreID);
				secGroupRestoreMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
				secGroupRestoreMembSysadmin.setRequiredSecGrpMembId(secGroupRestoreMembSysadminID);
				secGroupRestoreMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupRestoreMembSysadmin);
				secGroupRestoreMembSysadminID = secGroupRestoreMembSysadmin.getRequiredSecGrpMembId();
			}
		}
		
		if (isMutable) {
			if (secGroupMutate == null) {
				secGroupMutate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
				secGroupMutate.setRequiredRevision(1);
				secGroupMutate.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
				secGroupMutate.setRequiredName(mutatePermName);
				secGroupMutate.setRequiredIsVisible(true);
				secGroupMutate.setRequiredSecGroupId(secGroupMutateID);
				secGroupMutate = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupMutate);
				secGroupMutateID = secGroupMutate.getRequiredSecGroupId();
			}

			if (secGroupMutateMembSysadmin == null) {
				secGroupMutateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
				secGroupMutateMembSysadmin.setRequiredRevision(1);
				secGroupMutateMembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
				secGroupMutateMembSysadmin.setRequiredContainerGroup(secGroupMutateID);
				secGroupMutateMembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
				secGroupMutateMembSysadmin.setRequiredSecGrpMembId(secGroupMutateMembSysadminID);
				secGroupMutateMembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupMutateMembSysadmin);
				secGroupMutateMembSysadminID = secGroupMutateMembSysadmin.getRequiredSecGrpMembId();
			}
		}
	}		
</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaServiceBootstrapSecurity">$popto SchemaDef implJpaSchemaServiceBootstrapSecurity$</GenRule>
	<GenRule GenDef="SchemaDef" Name="implJpaSchemaServiceBootstrapSecurity">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower SecDbSchemaName$TransactionManager")
	public void bootstrapSecurity() {
		$SecSchemaName$JpaSysCluster sysCluster;
		CFLibDbKeyHash256 systemClusterID;
		$SecSchemaName$JpaCluster systemCluster;
		$SecSchemaName$JpaSecUser adminUser;
		CFLibDbKeyHash256 adminUID;
		$SecSchemaName$JpaSecSession bootstrapSession;
		CFLibDbKeyHash256 bootstrapSessionID;
		$SecSchemaName$JpaTenant systemTenant;
		CFLibDbKeyHash256 systemTenantID;
		$SecSchemaName$JpaSecGroup secGroupSysadmin;
		CFLibDbKeyHash256 secGroupSysadminID;
		$SecSchemaName$JpaSecGrpMemb secGroupSysadminMembSysadmin;
		CFLibDbKeyHash256 secGroupSysadminMembSysadminID;
		List&lt;$SecSchemaName$JpaSysCluster&gt; sysClusters = sysclusterService.findAll();
		if (sysClusters != null &amp;&amp; sysClusters.size() == 1) {
			sysCluster = sysClusters.get(0);
			systemClusterID = sysCluster.getRequiredClusterId();
			if(systemClusterID == null || systemClusterID.isNull()) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemClusterID");
			}
			systemCluster = clusterService.find(systemClusterID);
			if (systemCluster == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemCluster");
			}
			adminUID = systemCluster.getCreatedByUserId();
			if (adminUID == null || adminUID.isNull()) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "adminUID");
			}
			adminUser = secuserService.find(adminUID);
			if( adminUser == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "adminUser");
			}
			systemTenant = tenantService.findByUNameIdx(systemClusterID, "system");
			if( systemTenant == null) {
				systemTenantID = null;
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemTenant");
			}
			else {
				systemTenantID = systemTenant.getPKey();
			}
			bootstrapSession = secsessionService.findByStartIdx(adminUID, systemCluster.getCreatedAt());
			if (bootstrapSession == null) {
				List&lt;$SecSchemaName$JpaSecSession&gt; sessions = secsessionService.findBySecUserIdx(adminUID);
				if (sessions != null) {
					for ($SecSchemaName$JpaSecSession cursess: sessions) {
						if (bootstrapSession == null || (bootstrapSession != null &amp;&amp; (cursess.getRequiredStart().compareTo(bootstrapSession.getRequiredStart()) &lt; 0))) {
							bootstrapSession = cursess;
						}
					}
				}
				if (bootstrapSession == null) {
					throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "bootstrapSession");
				}
			}
			bootstrapSessionID = bootstrapSession.getPKey();

			secGroupSysadmin = ($SecSchemaName$JpaSecGroup)(secgroupService.findByUNameIdx(systemClusterID, "sysadmin"));
			if (secGroupSysadmin == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "secGroupSysadmin");
			}
			secGroupSysadminID = secGroupSysadmin.getRequiredSecGroupId();

			secGroupSysadminMembSysadmin = ($SecSchemaName$JpaSecGrpMemb)(secgrpmembService.findByUUserIdx(systemClusterID, secGroupSysadminID, adminUID));
			if (secGroupSysadminMembSysadmin == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "secGroupSysadminMembSysadmin");
			}
			secGroupSysadminMembSysadminID = secGroupSysadminMembSysadmin.getRequiredSecGrpMembId();
		}
		else {
			sysCluster = null;
			systemCluster = null;
			systemClusterID = null;
			adminUID = null;
			adminUser = null;
			bootstrapSession = null;
			bootstrapSessionID = null;
			systemTenant = null;
			systemTenantID = null;
			secGroupSysadmin = null;
			secGroupSysadminID = null;
			secGroupSysadminMembSysadmin = null;
			secGroupSysadminMembSysadminID = null;
		}
		LocalDateTime now = LocalDateTime.now();
		if (adminUID == null || adminUID.isNull()) {
			adminUID = new CFLibDbKeyHash256(0);
		}
		if (bootstrapSessionID == null || bootstrapSessionID.isNull()) {
			bootstrapSessionID = new CFLibDbKeyHash256(0);
		}
		if (systemClusterID == null || systemClusterID.isNull()) {
			systemClusterID = new CFLibDbKeyHash256(0);
		}
		if (systemTenantID == null || systemTenantID.isNull()) {
			systemTenantID = new CFLibDbKeyHash256(0);
		}
		if (secGroupSysadminID == null || secGroupSysadminID.isNull()) {
			secGroupSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupSysadminMembSysadminID == null || secGroupSysadminMembSysadminID.isNull()) {
			secGroupSysadminMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (I$SecSchemaName$Schema.getSysClusterId() == null || I$SecSchemaName$Schema.getSysClusterId().isNull()) {
			I$SecSchemaName$Schema.setSysClusterId(systemClusterID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysClusterId().equals( systemClusterID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system cluster id disagrees with new system cluster id", "Previously set system cluster id disagrees with new system cluster id");
		}
		if (I$SecSchemaName$Schema.getSysTenantId() == null || I$SecSchemaName$Schema.getSysTenantId().isNull()) {
			I$SecSchemaName$Schema.setSysTenantId(systemTenantID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysTenantId().equals( systemTenantID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system tenant id disagrees with new system tenant id", "Previously set system tenant id disagrees with new system tenant id");
		}
		if (I$SecSchemaName$Schema.getSysAdminId() == null || I$SecSchemaName$Schema.getSysAdminId().isNull()) {
			I$SecSchemaName$Schema.setSysAdminId(adminUID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysAdminId().equals( adminUID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system admin id disagrees with new system admin id", "Previously set system admin id disagrees with new system admin id");
		}

		String fqdn;
		try {
			InetAddress localHost = InetAddress.getLocalHost();
			fqdn = localHost.getCanonicalHostName();
		} catch (java.net.UnknownHostException e) {
			fqdn = "localhost";
		}
		if (systemCluster == null) {
			systemCluster = new $SecSchemaName$JpaCluster();
			systemCluster.setRequiredRevision(1);
			systemCluster.setRequiredId(systemClusterID);
			systemCluster.setCreatedByUserId(adminUID);
			systemCluster.setUpdatedByUserId(adminUID);
			systemCluster.setCreatedAt(now);
			systemCluster.setUpdatedAt(now);
			systemCluster.setRequiredFullDomName(fqdn);
			systemCluster.setRequiredDescription("System cluster for " + fqdn);
			systemCluster = clusterService.create(systemCluster);
			systemClusterID = systemCluster.getPKey();
		}
		if (adminUser == null) {
			adminUser = new $SecSchemaName$JpaSecUser();
			adminUser.setRequiredRevision(1);
			adminUser.setCreatedByUserId(adminUID);
			adminUser.setUpdatedByUserId(adminUID);
			adminUser.setCreatedAt(now);
			adminUser.setUpdatedAt(now);
			adminUser.setRequiredSecUserId(adminUID);
			adminUser.setRequiredLoginId("sysadmin");
			adminUser.setRequiredEMailAddress("sysadmin@" + fqdn);
			adminUser.setRequiredPasswordHash(I$SecSchemaName$Schema.getPasswordHash("ChangeOnInstall"));
			adminUser = secuserService.create(adminUser);
			adminUID = adminUser.getPKey();
		}
		if (systemTenant == null) {
			systemTenant = new $SecSchemaName$JpaTenant();
			systemTenant.setRequiredRevision(1);
			systemTenant.setRequiredId(systemTenantID);
			systemTenant.setCreatedByUserId(adminUID);
			systemTenant.setUpdatedByUserId(adminUID);
			systemTenant.setCreatedAt(now);
			systemTenant.setUpdatedAt(now);
			systemTenant.setRequiredContainerCluster(systemClusterID);
			systemTenant.setRequiredTenantName("system");
			systemTenant = tenantService.create(systemTenant);
			systemTenantID = systemTenant.getPKey();
		}
		if (bootstrapSession == null) {
			bootstrapSession = new $SecSchemaName$JpaSecSession();
			bootstrapSession.setRequiredRevision(1);
			bootstrapSession.setRequiredSecSessionId(bootstrapSessionID);
			bootstrapSession.setRequiredSecUserId(adminUID);
			bootstrapSession.setOptionalSecProxyId(adminUID);
			bootstrapSession.setOptionalSecDevName(null);
			bootstrapSession.setRequiredStart(now);
			bootstrapSession.setOptionalFinish(null);
			bootstrapSession = secsessionService.create(bootstrapSession);
		}
//		bootstrapSessionID = bootstrapSession.getPKey();
			
		if (sysCluster == null) {
			sysCluster = new $SecSchemaName$JpaSysCluster();
			sysCluster.setRequiredContainerCluster(systemClusterID);
			sysCluster = sysclusterService.create(sysCluster);
		}

		if (secGroupSysadmin == null) {
			secGroupSysadmin = new $SecSchemaName$JpaSecGroup();
			secGroupSysadmin.setRequiredRevision(1);
			secGroupSysadmin.setRequiredContainerCluster(systemClusterID);
			secGroupSysadmin.setRequiredName("sysadmin");
			secGroupSysadmin.setRequiredIsVisible(true);
			secGroupSysadmin.setRequiredSecGroupId(secGroupSysadminID);
			secGroupSysadmin = ($SecSchemaName$JpaSecGroup)(secgroupService.create(secGroupSysadmin));
			secGroupSysadminID = secGroupSysadmin.getRequiredSecGroupId();
		}

		if (secGroupSysadminMembSysadmin == null) {
			secGroupSysadminMembSysadmin = new $SecSchemaName$JpaSecGrpMemb();
			secGroupSysadminMembSysadmin.setRequiredRevision(1);
			secGroupSysadminMembSysadmin.setRequiredOwnerCluster(systemClusterID);
			secGroupSysadminMembSysadmin.setRequiredContainerGroup(secGroupSysadminID);
			secGroupSysadminMembSysadmin.setRequiredParentUser(adminUID);
			secGroupSysadminMembSysadmin.setRequiredSecGrpMembId(secGroupSysadminMembSysadminID);
			secGroupSysadminMembSysadmin = ($SecSchemaName$JpaSecGrpMemb)(secgrpmembService.create(secGroupSysadminMembSysadmin));
			secGroupSysadminMembSysadminID = secGroupSysadminMembSysadmin.getRequiredSecGrpMembId();
		}

		if (bootstrapSession != null &amp;&amp; bootstrapSessionID != null &amp;&amp; !bootstrapSessionID.isNull() &amp;&amp; bootstrapSession.getOptionalFinish() == null) {
			bootstrapSession.setOptionalFinish(LocalDateTime.now());
			bootstrapSession = secsessionService.update(bootstrapSession);
		}
	}
</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaServiceBootstrapAllTablesSecurity">$popto SchemaDef implJpaSchemaServiceBootstrapAllTablesSecurity$</GenRule>
	<GenRule GenDef="SchemaDef" Name="implJpaSchemaServiceBootstrapAllTablesSecurity">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower SecDbSchemaName$TransactionManager")
	public void bootstrapAllTablesSecurity() {
		LocalDateTime now = LocalDateTime.now();
		I$SecSchemaName$SecSession bootstrapSession;
		CFLibDbKeyHash256 bootstrapSessionID = new CFLibDbKeyHash256(0);

		I$SecSchemaName$Authorization auth = new $SecSchemaName$Authorization();
		auth.setAuthUuid6(CFLibUuid6.generateUuid6());
		auth.setSecClusterId(I$SecSchemaName$Schema.getSysClusterId());
		auth.setSecTenantId(I$SecSchemaName$Schema.getSysTenantId());
		auth.setSecSessionId(bootstrapSessionID);
//I$SecSchemaName$Schema.getSysTenantId(), I$SecSchemaName$Schema.getSysAdminId()
		bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecSession().newRec();
		bootstrapSession.setRequiredRevision(1);
		bootstrapSession.setRequiredSecSessionId(bootstrapSessionID);
		bootstrapSession.setRequiredSecUserId(I$SecSchemaName$Schema.getSysAdminId());
		bootstrapSession.setOptionalSecProxyId(I$SecSchemaName$Schema.getSysAdminId());
		bootstrapSession.setOptionalSecDevName(null);
		bootstrapSession.setRequiredStart(now);
		bootstrapSession.setOptionalFinish(null);
		bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecSession().createSecSession(auth, bootstrapSession);
		bootstrapSessionID = bootstrapSession.getRequiredSecSessionId();
$iterate Tables( each maybeInvokeBootstrapTableSecurity empty empty )$

		if (bootstrapSession != null &amp;&amp; bootstrapSessionID != null &amp;&amp; !bootstrapSessionID.isNull() &amp;&amp; bootstrapSession.getOptionalFinish() == null) {
			bootstrapSession.setOptionalFinish(LocalDateTime.now());
			bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecSession().updateSecSession(auth, bootstrapSession);
		}
	}
</GenRule>

	<GenRule GenDef="Table" Name="maybeInvokeBootstrapTableSecurity">$switch HasDefSchema yes empty default invokeBootstrapTableSecurity$</GenRule>
	<GenRule GenDef="Table" Name="invokeBootstrapTableSecurity">
		bootstrapTableSecurity(auth, "$TableName$", $switch HasHistory yes emitTrue default emitFalse$, $switch IsMutable yes emitTrue default emitFalse$);</GenRule>

	<GenRule GenDef="Object" Name="emitTrue">true</GenRule>
	<GenRule GenDef="Object" Name="emitFalse">false</GenRule>

	<GenRule GenDef="Table" Name="maybeImplJpaSchemaServiceBootstrapTable">$switch HasDefSchema yes empty default implJpaSchemaServiceBootstrapTable$</GenRule>
	<GenRule GenDef="Table" Name="implJpaSchemaServiceBootstrapTable">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower DefDbSchemaName$TransactionManager")
	public void bootstrapTable$TableName$Security(I$SecSchemaName$Authorization auth) {
		LocalDateTime now = LocalDateTime.now();
$declGroupsAndMembers$
$resolveGroupsAndMembers$
$initGroupAndMemberIDs$
$createMissingGroupsAndMembers$
	}		
</GenRule>

</RuleSet>
