<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Mark's Code Fractal CFKBase 3.1 Code Fractal Knowledge Base
 *
 *	Copyright 2016-2026 Mark Stephen Sobkow
 *
 *	This file is part of Mark's Code Fractal CFKBase.
 *
 *	Mark's Code Fractal CFKBase is available under dual commercial license from
 *	Mark Stephen Sobkow, or under the terms of the GNU General Public License,
 *	Version 3 or later.
 *
 *	Mark's Code Fractal CFKBase is free software: you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	Mark's Code Fractal CFKBase is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Mark's Code Fractal CFKBase.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 *
 *	If you wish to modify and use this code without publishing your changes,
 *	or integrate it with proprietary code, please contact Mark Stephen Sobkow
 *	for a commercial license at mark.sobkow@gmail.com
 * -->
<RuleSet
	xmlns="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xsi:schemaLocation="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	ToolSet="java"
	Name="src/Schema/jpa/SchemaJpaSchemaService.java"
	Revision="3.0"
	Descr="Java 25 Spring JPA Service for Schema">

	<GenFile GenDef="SchemaDef" Name="fileSchemaJpaSchemaServiceJava"
			GenerateOnce="false"
		ModuleName="$reference ManufacturingSchema lower JavaPackage$.jpa"
		SourceBundle="java"
		BasePackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$jpa/src/main/java"
		SubPackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa"
		ExpansionClassName="$SchemaName$JpaSchemaServiceJava"
		ExpansionKeyName="$SchemaName$JpaSchemaServiceJava"
		ExpansionFileName="$SchemaName$JpaSchemaService.java"
>// Description: Java 25 Spring JPA Service for $SchemaName$

$MssSourceLicense$

package $lower DefTopProjectName$.$DefVUnderVersion$.$lower DefSubProjectName$.$lower DefSchemaName$.jpa;

import java.io.Serializable;
import java.math.*;
import java.net.InetAddress;
import java.time.*;
import java.util.*;
import jakarta.persistence.*;
import io.github.msobkow.v3_1.cflib.*;
import io.github.msobkow.v3_1.cflib.dbutil.*;
import io.github.msobkow.v3_1.cflib.xml.CFLibXmlUtil;
import org.apache.commons.codec.binary.Base64;
import org.apache.commons.text.StringEscapeUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;$poptop SchemaDef iterate SchemaRefs( each importJavaPackageSchemaName empty empty )$
import $lower DefTopProjectName$.$DefVUnderVersion$.$lower DefSubProjectName$.$lower DefSchemaName$.*;

/**
 *	Services for schema $SchemaName$ defined in $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$.jpa
 *	using the $SchemaName$*Repository objects to access the data directly, bypassing normal application security for the bootstrap and login processing.
 */
@Service("$lower DefDbSchemaName$JpaSchemaService")
public class $SchemaName$JpaSchemaService {

	@Autowired
	@Qualifier("$lower DefDbSchemaName$EntityManagerFactory")
	private LocalContainerEntityManagerFactoryBean $lower DefDbSchemaName$EntityManagerFactory;$iterate Tables( each JpaSchemaServiceMaybeAutowireService empty empty )$
$JpaSchemaServiceBootstrap$
}
</GenFile>

	<GenRule GenDef="Table" Name="JpaSchemaServiceMaybeAutowireService">$switch HasDefSchema yes empty default JpaSchemaServiceAutowireService$</GenRule>
	<GenRule GenDef="Table" Name="JpaSchemaServiceAutowireService">
	@Autowired
	private $DefSchemaName$Jpa$TableName$Service $lower TableName$Service;
</GenRule>

	<GenRule GenDef="SchemaDef" Name="JpaSchemaServiceBootstrap">
	public void bootstrapSchema() {$iterate SchemaRefs( each invokeJpaSchemaServiceBootstrapReferenced empty empty )$$iterate SchemaRefs( empty invokeJpaSchemaServiceBootstrapSecurity each empty )$
		bootstrapAllTablesSecurity();
	}
$iterate SchemaRefs( empty implJpaSchemaServiceBootstrapSecurity each empty )$$implJpaSchemaServiceBootstrapAllTablesSecurity$$iterate Tables( each maybeImplJpaSchemaServiceBootstrapTable empty empty )$
</GenRule>

	<GenRule GenDef="SchemaRef" Name="invokeJpaSchemaServiceBootstrapReferenced">$reference RefSchema invokeJpaSchemaServiceBootstrapReferenced$</GenRule>
	<GenRule GenDef="SchemaDef" Name="invokeJpaSchemaServiceBootstrapReferenced">
		I$SchemaName$Schema.getBacking$SchemaName$().bootstrapSchema();</GenRule>
	<GenRule GenDef="Object" Name="invokeJpaSchemaServiceBootstrapSecurity">
		bootstrapSecurity();</GenRule>
		
	<GenRule GenDef="Table" Name="maybeDeclGroupsAndMembers">$switch HasDefSchema yes empty default declGroupsAndMembers$</GenRule>
	<GenRule GenDef="Table" Name="declGroupsAndMembers">$declCreateGroupAndMember$$declReadGroupAndMember$$declUpdateGroupAndMember$$declDeleteGroupAndMember$</GenRule>

	<GenRule GenDef="Table" Name="declCreateGroupAndMember">
		I$SecSchemaName$SecGroup secGroupCreate$TableName$;
		CFLibDbKeyHash256 secGroupCreate$TableName$ID;
		I$SecSchemaName$SecGrpMemb secGroupCreate$TableName$MembSysadmin;
		CFLibDbKeyHash256 secGroupCreate$TableName$MembSysadminID;</GenRule>

	<GenRule GenDef="Table" Name="declReadGroupAndMember">
		I$SecSchemaName$SecGroup secGroupRead$TableName$;
		CFLibDbKeyHash256 secGroupRead$TableName$ID;
		I$SecSchemaName$SecGrpMemb secGroupRead$TableName$MembSysadmin;
		CFLibDbKeyHash256 secGroupRead$TableName$MembSysadminID;</GenRule>

	<GenRule GenDef="Table" Name="declUpdateGroupAndMember">
		I$SecSchemaName$SecGroup secGroupUpdate$TableName$;
		CFLibDbKeyHash256 secGroupUpdate$TableName$ID;
		I$SecSchemaName$SecGrpMemb secGroupUpdate$TableName$MembSysadmin;
		CFLibDbKeyHash256 secGroupUpdate$TableName$MembSysadminID;</GenRule>

	<GenRule GenDef="Table" Name="declDeleteGroupAndMember">
		I$SecSchemaName$SecGroup secGroupDelete$TableName$;
		CFLibDbKeyHash256 secGroupDelete$TableName$ID;
		I$SecSchemaName$SecGrpMemb secGroupDelete$TableName$MembSysadmin;
		CFLibDbKeyHash256 secGroupDelete$TableName$MembSysadminID;</GenRule>

	<GenRule GenDef="Table" Name="maybeNullifyGroupsAndMembers">$switch HasDefSchema yes empty default nullifyGroupsAndMembers$</GenRule>
	<GenRule GenDef="Table" Name="nullifyGroupsAndMembers">
			secGroupCreate$TableName$ = null;
			secGroupCreate$TableName$ID = null;
			secGroupRead$TableName$ = null;
			secGroupRead$TableName$ID = null;
			secGroupUpdate$TableName$ = null;
			secGroupUpdate$TableName$ID = null;
			secGroupDelete$TableName$ = null;
			secGroupDelete$TableName$ID = null;</GenRule>

	<GenRule GenDef="Table" Name="maybeResolveGroupsAndMembers">$switch HasDefSchema yes empty default resolveGroupsAndMembers$</GenRule>
	<GenRule GenDef="Table" Name="resolveGroupsAndMembers">$resolveCreateGroupAndMember$$resolveReadGroupAndMember$$resolveUpdateGroupAndMember$$resolveDeleteGroupAndMember$</GenRule>
	
	<GenRule GenDef="Table" Name="resolveCreateGroupAndMember">
		secGroupCreate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), "Create$TableName$");
		if (secGroupCreate$TableName$ != null) {
			secGroupCreate$TableName$ID = secGroupCreate$TableName$.getRequiredSecGroupId();
			secGroupCreate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupCreate$TableName$ID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupCreate$TableName$MembSysadmin != null) {
				secGroupCreate$TableName$MembSysadminID = secGroupCreate$TableName$MembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupCreate$TableName$MembSysadminID = null;
			}
		}
		else {
			secGroupCreate$TableName$ID = null;
			secGroupCreate$TableName$MembSysadmin = null;
			secGroupCreate$TableName$MembSysadminID = null;
		}
</GenRule>
	
	<GenRule GenDef="Table" Name="resolveReadGroupAndMember">
		secGroupRead$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), "Read$TableName$");
		if (secGroupRead$TableName$ != null) {
			secGroupRead$TableName$ID = secGroupRead$TableName$.getRequiredSecGroupId();
			secGroupRead$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupRead$TableName$ID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupRead$TableName$MembSysadmin != null) {
				secGroupRead$TableName$MembSysadminID = secGroupRead$TableName$MembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupRead$TableName$MembSysadminID = null;
			}
		}
		else {
			secGroupRead$TableName$ID = null;
			secGroupRead$TableName$MembSysadmin = null;
			secGroupRead$TableName$MembSysadminID = null;
		}
</GenRule>

	<GenRule GenDef="Table" Name="resolveUpdateGroupAndMember">
		secGroupUpdate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), "Update$TableName$");
		if (secGroupUpdate$TableName$ != null) {
			secGroupUpdate$TableName$ID = secGroupUpdate$TableName$.getRequiredSecGroupId();
			secGroupUpdate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupUpdate$TableName$ID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupUpdate$TableName$MembSysadmin != null) {
				secGroupUpdate$TableName$MembSysadminID = secGroupUpdate$TableName$MembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupUpdate$TableName$MembSysadminID = null;
			}
		}
		else {
			secGroupUpdate$TableName$ID = null;
			secGroupUpdate$TableName$MembSysadmin = null;
			secGroupUpdate$TableName$MembSysadminID = null;
		}
</GenRule>

	<GenRule GenDef="Table" Name="resolveDeleteGroupAndMember">
		secGroupDelete$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().readDerivedByUNameIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), "Delete$TableName$");
		if (secGroupDelete$TableName$ != null) {
			secGroupDelete$TableName$ID = secGroupDelete$TableName$.getRequiredSecGroupId();
			secGroupDelete$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().readDerivedByUUserIdx(auth, I$SecSchemaName$Schema.getSysClusterId(), secGroupDelete$TableName$ID, I$SecSchemaName$Schema.getSysAdminId());
			if (secGroupDelete$TableName$MembSysadmin != null) {
				secGroupDelete$TableName$MembSysadminID = secGroupDelete$TableName$MembSysadmin.getRequiredSecGrpMembId();
			}
			else {
				secGroupDelete$TableName$MembSysadminID = null;
			}
		}
		else {
			secGroupDelete$TableName$ID = null;
			secGroupDelete$TableName$MembSysadmin = null;
			secGroupDelete$TableName$MembSysadminID = null;
		}
</GenRule>

	<GenRule GenDef="Table" Name="maybeCreateMissingGroupsAndMembers">$switch HasDefSchema yes empty default createMissingGroupsAndMembers$</GenRule>
	<GenRule GenDef="Table" Name="createMissingGroupsAndMembers">$createMissingCreateGroupsAndMembers$$createMissingReadGroupsAndMembers$$createMissingUpdateGroupsAndMembers$$createMissingDeleteGroupsAndMembers$</GenRule>

	<GenRule GenDef="Table" Name="createMissingCreateGroupsAndMembers">
		if (secGroupCreate$TableName$ == null) {
			secGroupCreate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupCreate$TableName$.setRequiredRevision(1);
			secGroupCreate$TableName$.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupCreate$TableName$.setRequiredName("Create$TableName$");
			secGroupCreate$TableName$.setRequiredIsVisible(true);
			secGroupCreate$TableName$.setRequiredSecGroupId(secGroupCreate$TableName$ID);
			secGroupCreate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupCreate$TableName$);
			secGroupCreate$TableName$ID = secGroupCreate$TableName$.getRequiredSecGroupId();
		}

		if (secGroupCreate$TableName$MembSysadmin == null) {
			secGroupCreate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupCreate$TableName$MembSysadmin.setRequiredRevision(1);
			secGroupCreate$TableName$MembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupCreate$TableName$MembSysadmin.setRequiredContainerGroup(secGroupCreate$TableName$ID);
			secGroupCreate$TableName$MembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupCreate$TableName$MembSysadmin.setRequiredSecGrpMembId(secGroupCreate$TableName$MembSysadminID);
			secGroupCreate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupCreate$TableName$MembSysadmin);
			secGroupCreate$TableName$MembSysadminID = secGroupCreate$TableName$MembSysadmin.getRequiredSecGrpMembId();
		}
</GenRule>

	<GenRule GenDef="Table" Name="createMissingReadGroupsAndMembers">
		if (secGroupRead$TableName$ == null) {
			secGroupRead$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupRead$TableName$.setRequiredRevision(1);
			secGroupRead$TableName$.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupRead$TableName$.setRequiredName("Read$TableName$");
			secGroupRead$TableName$.setRequiredIsVisible(true);
			secGroupRead$TableName$.setRequiredSecGroupId(secGroupRead$TableName$ID);
			secGroupRead$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupRead$TableName$);
			secGroupRead$TableName$ID = secGroupRead$TableName$.getRequiredSecGroupId();
		}

		if (secGroupRead$TableName$MembSysadmin == null) {
			secGroupRead$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupRead$TableName$MembSysadmin.setRequiredRevision(1);
			secGroupRead$TableName$MembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupRead$TableName$MembSysadmin.setRequiredContainerGroup(secGroupRead$TableName$ID);
			secGroupRead$TableName$MembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupRead$TableName$MembSysadmin.setRequiredSecGrpMembId(secGroupRead$TableName$MembSysadminID);
			secGroupRead$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupRead$TableName$MembSysadmin);
			secGroupRead$TableName$MembSysadminID = secGroupRead$TableName$MembSysadmin.getRequiredSecGrpMembId();
		}
</GenRule>

	<GenRule GenDef="Table" Name="createMissingUpdateGroupsAndMembers">
		if (secGroupUpdate$TableName$ == null) {
			secGroupUpdate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupUpdate$TableName$.setRequiredRevision(1);
			secGroupUpdate$TableName$.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupUpdate$TableName$.setRequiredName("Update$TableName$");
			secGroupUpdate$TableName$.setRequiredIsVisible(true);
			secGroupUpdate$TableName$.setRequiredSecGroupId(secGroupUpdate$TableName$ID);
			secGroupUpdate$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupUpdate$TableName$);
			secGroupUpdate$TableName$ID = secGroupUpdate$TableName$.getRequiredSecGroupId();
		}

		if (secGroupUpdate$TableName$MembSysadmin == null) {
			secGroupUpdate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupUpdate$TableName$MembSysadmin.setRequiredRevision(1);
			secGroupUpdate$TableName$MembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupUpdate$TableName$MembSysadmin.setRequiredContainerGroup(secGroupUpdate$TableName$ID);
			secGroupUpdate$TableName$MembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupUpdate$TableName$MembSysadmin.setRequiredSecGrpMembId(secGroupUpdate$TableName$MembSysadminID);
			secGroupUpdate$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupUpdate$TableName$MembSysadmin);
			secGroupUpdate$TableName$MembSysadminID = secGroupUpdate$TableName$MembSysadmin.getRequiredSecGrpMembId();
		}
</GenRule>

	<GenRule GenDef="Table" Name="createMissingDeleteGroupsAndMembers">
		if (secGroupDelete$TableName$ == null) {
			secGroupDelete$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGroup().newRec();
			secGroupDelete$TableName$.setRequiredRevision(1);
			secGroupDelete$TableName$.setRequiredContainerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupDelete$TableName$.setRequiredName("Delete$TableName$");
			secGroupDelete$TableName$.setRequiredIsVisible(true);
			secGroupDelete$TableName$.setRequiredSecGroupId(secGroupDelete$TableName$ID);
			secGroupDelete$TableName$ = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGroup().createSecGroup(auth, secGroupDelete$TableName$);
			secGroupDelete$TableName$ID = secGroupDelete$TableName$.getRequiredSecGroupId();
		}

		if (secGroupDelete$TableName$MembSysadmin == null) {
			secGroupDelete$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecGrpMemb().newRec();
			secGroupDelete$TableName$MembSysadmin.setRequiredRevision(1);
			secGroupDelete$TableName$MembSysadmin.setRequiredOwnerCluster(I$SecSchemaName$Schema.getSysClusterId());
			secGroupDelete$TableName$MembSysadmin.setRequiredContainerGroup(secGroupDelete$TableName$ID);
			secGroupDelete$TableName$MembSysadmin.setRequiredParentUser(I$SecSchemaName$Schema.getSysAdminId());
			secGroupDelete$TableName$MembSysadmin.setRequiredSecGrpMembId(secGroupDelete$TableName$MembSysadminID);
			secGroupDelete$TableName$MembSysadmin = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecGrpMemb().createSecGrpMemb(auth, secGroupDelete$TableName$MembSysadmin);
			secGroupDelete$TableName$MembSysadminID = secGroupDelete$TableName$MembSysadmin.getRequiredSecGrpMembId();
		}
</GenRule>

	<GenRule GenDef="Table" Name="maybeInitGroupAndMemberIDs">$switch HasDefSchema yes empty default initGroupAndMemberIDs$</GenRule>
	<GenRule GenDef="Table" Name="initGroupAndMemberIDs">
		if (secGroupCreate$TableName$ID == null || secGroupCreate$TableName$ID.isNull()) {
			secGroupCreate$TableName$ID = new CFLibDbKeyHash256(0);
		}
		if (secGroupCreate$TableName$MembSysadminID == null || secGroupCreate$TableName$MembSysadminID.isNull()) {
			secGroupCreate$TableName$MembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupRead$TableName$ID == null || secGroupRead$TableName$ID.isNull()) {
			secGroupRead$TableName$ID = new CFLibDbKeyHash256(0);
		}
		if (secGroupRead$TableName$MembSysadminID == null || secGroupRead$TableName$MembSysadminID.isNull()) {
			secGroupRead$TableName$MembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupUpdate$TableName$ID == null || secGroupUpdate$TableName$ID.isNull()) {
			secGroupUpdate$TableName$ID = new CFLibDbKeyHash256(0);
		}
		if (secGroupUpdate$TableName$MembSysadminID == null || secGroupUpdate$TableName$MembSysadminID.isNull()) {
			secGroupUpdate$TableName$MembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupDelete$TableName$ID == null || secGroupDelete$TableName$ID.isNull()) {
			secGroupDelete$TableName$ID = new CFLibDbKeyHash256(0);
		}
		if (secGroupDelete$TableName$MembSysadminID == null || secGroupDelete$TableName$MembSysadminID.isNull()) {
			secGroupDelete$TableName$MembSysadminID = new CFLibDbKeyHash256(0);
		}</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaServiceBootstrapSecurity">$popto SchemaDef implJpaSchemaServiceBootstrapSecurity$</GenRule>
	<GenRule GenDef="SchemaDef" Name="implJpaSchemaServiceBootstrapSecurity">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower DefDbSchemaName$TransactionManager")
	public void bootstrapSecurity() {
		$SecSchemaName$JpaSysCluster sysCluster;
		CFLibDbKeyHash256 systemClusterID;
		$SecSchemaName$JpaCluster systemCluster;
		$SecSchemaName$JpaSecUser adminUser;
		CFLibDbKeyHash256 adminUID;
		$SecSchemaName$JpaSecSession bootstrapSession;
		CFLibDbKeyHash256 bootstrapSessionID;
		$SecSchemaName$JpaTenant systemTenant;
		CFLibDbKeyHash256 systemTenantID;
		$SecSchemaName$JpaSecGroup secGroupSysadmin;
		CFLibDbKeyHash256 secGroupSysadminID;
		$SecSchemaName$JpaSecGrpMemb secGroupSysadminMembSysadmin;
		CFLibDbKeyHash256 secGroupSysadminMembSysadminID;
		List&lt;$SecSchemaName$JpaSysCluster&gt; sysClusters = sysclusterService.findAll();
		if (sysClusters != null &amp;&amp; sysClusters.size() == 1) {
			sysCluster = sysClusters.get(0);
			systemClusterID = sysCluster.getRequiredClusterId();
			if(systemClusterID == null || systemClusterID.isNull()) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemClusterID");
			}
			systemCluster = clusterService.find(systemClusterID);
			if (systemCluster == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemCluster");
			}
			adminUID = systemCluster.getCreatedByUserId();
			if (adminUID == null || adminUID.isNull()) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "adminUID");
			}
			adminUser = secuserService.find(adminUID);
			if( adminUser == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "adminUser");
			}
			systemTenant = tenantService.findByUNameIdx(systemClusterID, "system");
			if( systemTenant == null) {
				systemTenantID = null;
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "systemTenant");
			}
			else {
				systemTenantID = systemTenant.getPKey();
			}
			bootstrapSession = secsessionService.findByStartIdx(adminUID, systemCluster.getCreatedAt());
			if (bootstrapSession == null) {
				List&lt;$SecSchemaName$JpaSecSession&gt; sessions = secsessionService.findBySecUserIdx(adminUID);
				if (sessions != null) {
					for ($SecSchemaName$JpaSecSession cursess: sessions) {
						if (bootstrapSession == null || (bootstrapSession != null &amp;&amp; (cursess.getRequiredStart().compareTo(bootstrapSession.getRequiredStart()) &lt; 0))) {
							bootstrapSession = cursess;
						}
					}
				}
				if (bootstrapSession == null) {
					throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "bootstrapSession");
				}
			}
			bootstrapSessionID = bootstrapSession.getPKey();

			secGroupSysadmin = ($SecSchemaName$JpaSecGroup)(secgroupService.findByUNameIdx(systemClusterID, "sysadmin"));
			if (secGroupSysadmin == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "secGroupSysadmin");
			}
			secGroupSysadminID = secGroupSysadmin.getRequiredSecGroupId();

			secGroupSysadminMembSysadmin = ($SecSchemaName$JpaSecGrpMemb)(secgrpmembService.findByUUserIdx(systemClusterID, secGroupSysadminID, adminUID));
			if (secGroupSysadminMembSysadmin == null) {
				throw new CFLibNullArgumentException(getClass(), "bootstrapSchema", 0, "secGroupSysadminMembSysadmin");
			}
			secGroupSysadminMembSysadminID = secGroupSysadminMembSysadmin.getRequiredSecGrpMembId();
		}
		else {
			sysCluster = null;
			systemCluster = null;
			systemClusterID = null;
			adminUID = null;
			adminUser = null;
			bootstrapSession = null;
			bootstrapSessionID = null;
			systemTenant = null;
			systemTenantID = null;
			secGroupSysadmin = null;
			secGroupSysadminID = null;
			secGroupSysadminMembSysadmin = null;
			secGroupSysadminMembSysadminID = null;
		}
		LocalDateTime now = LocalDateTime.now();
		if (adminUID == null || adminUID.isNull()) {
			adminUID = new CFLibDbKeyHash256(0);
		}
		if (bootstrapSessionID == null || bootstrapSessionID.isNull()) {
			bootstrapSessionID = new CFLibDbKeyHash256(0);
		}
		if (systemClusterID == null || systemClusterID.isNull()) {
			systemClusterID = new CFLibDbKeyHash256(0);
		}
		if (systemTenantID == null || systemTenantID.isNull()) {
			systemTenantID = new CFLibDbKeyHash256(0);
		}
		if (secGroupSysadminID == null || secGroupSysadminID.isNull()) {
			secGroupSysadminID = new CFLibDbKeyHash256(0);
		}
		if (secGroupSysadminMembSysadminID == null || secGroupSysadminMembSysadminID.isNull()) {
			secGroupSysadminMembSysadminID = new CFLibDbKeyHash256(0);
		}
		if (I$SecSchemaName$Schema.getSysClusterId() == null || I$SecSchemaName$Schema.getSysClusterId().isNull()) {
			I$SecSchemaName$Schema.setSysClusterId(systemClusterID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysClusterId().equals( systemClusterID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system cluster id disagrees with new system cluster id", "Previously set system cluster id disagrees with new system cluster id");
		}
		if (I$SecSchemaName$Schema.getSysTenantId() == null || I$SecSchemaName$Schema.getSysTenantId().isNull()) {
			I$SecSchemaName$Schema.setSysTenantId(systemTenantID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysTenantId().equals( systemTenantID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system tenant id disagrees with new system tenant id", "Previously set system tenant id disagrees with new system tenant id");
		}
		if (I$SecSchemaName$Schema.getSysAdminId() == null || I$SecSchemaName$Schema.getSysAdminId().isNull()) {
			I$SecSchemaName$Schema.setSysAdminId(adminUID);
		}
		else if ( ! I$SecSchemaName$Schema.getSysAdminId().equals( adminUID )) {
			throw new CFLibInvalidArgumentException(getClass(), "bootstrapSchema", "Previously set system admin id disagrees with new system admin id", "Previously set system admin id disagrees with new system admin id");
		}

		String fqdn;
		try {
			InetAddress localHost = InetAddress.getLocalHost();
			fqdn = localHost.getCanonicalHostName();
		} catch (java.net.UnknownHostException e) {
			fqdn = "localhost";
		}
		if (systemCluster == null) {
			systemCluster = new $SecSchemaName$JpaCluster();
			systemCluster.setRequiredRevision(1);
			systemCluster.setRequiredId(systemClusterID);
			systemCluster.setCreatedByUserId(adminUID);
			systemCluster.setUpdatedByUserId(adminUID);
			systemCluster.setCreatedAt(now);
			systemCluster.setUpdatedAt(now);
			systemCluster.setRequiredFullDomName(fqdn);
			systemCluster.setRequiredDescription("System cluster for " + fqdn);
			systemCluster = clusterService.create(systemCluster);
			systemClusterID = systemCluster.getPKey();
		}
		if (adminUser == null) {
			adminUser = new $SecSchemaName$JpaSecUser();
			adminUser.setRequiredRevision(1);
			adminUser.setCreatedByUserId(adminUID);
			adminUser.setUpdatedByUserId(adminUID);
			adminUser.setCreatedAt(now);
			adminUser.setUpdatedAt(now);
			adminUser.setRequiredSecUserId(adminUID);
			adminUser.setRequiredLoginId("sysadmin");
			adminUser.setRequiredEMailAddress("sysadmin@" + fqdn);
			adminUser.setRequiredPasswordHash(I$SecSchemaName$Schema.getPasswordHash("ChangeOnInstall"));
			adminUser = secuserService.create(adminUser);
			adminUID = adminUser.getPKey();
		}
		if (systemTenant == null) {
			systemTenant = new $SecSchemaName$JpaTenant();
			systemTenant.setRequiredRevision(1);
			systemTenant.setRequiredId(systemTenantID);
			systemTenant.setCreatedByUserId(adminUID);
			systemTenant.setUpdatedByUserId(adminUID);
			systemTenant.setCreatedAt(now);
			systemTenant.setUpdatedAt(now);
			systemTenant.setRequiredContainerCluster(systemClusterID);
			systemTenant.setRequiredTenantName("system");
			systemTenant = tenantService.create(systemTenant);
			systemTenantID = systemTenant.getPKey();
		}
		if (bootstrapSession == null) {
			bootstrapSession = new $SecSchemaName$JpaSecSession();
			bootstrapSession.setRequiredRevision(1);
			bootstrapSession.setRequiredSecSessionId(bootstrapSessionID);
			bootstrapSession.setRequiredSecUserId(adminUID);
			bootstrapSession.setOptionalSecProxyId(adminUID);
			bootstrapSession.setOptionalSecDevName(null);
			bootstrapSession.setRequiredStart(now);
			bootstrapSession.setOptionalFinish(null);
			bootstrapSession = secsessionService.create(bootstrapSession);
		}
//		bootstrapSessionID = bootstrapSession.getPKey();
			
		if (sysCluster == null) {
			sysCluster = new $SecSchemaName$JpaSysCluster();
			sysCluster.setRequiredContainerCluster(systemClusterID);
			sysCluster = sysclusterService.create(sysCluster);
		}

		if (secGroupSysadmin == null) {
			secGroupSysadmin = new $SecSchemaName$JpaSecGroup();
			secGroupSysadmin.setRequiredRevision(1);
			secGroupSysadmin.setRequiredContainerCluster(systemClusterID);
			secGroupSysadmin.setRequiredName("sysadmin");
			secGroupSysadmin.setRequiredIsVisible(true);
			secGroupSysadmin.setRequiredSecGroupId(secGroupSysadminID);
			secGroupSysadmin = ($SecSchemaName$JpaSecGroup)(secgroupService.create(secGroupSysadmin));
			secGroupSysadminID = secGroupSysadmin.getRequiredSecGroupId();
		}

		if (secGroupSysadminMembSysadmin == null) {
			secGroupSysadminMembSysadmin = new $SecSchemaName$JpaSecGrpMemb();
			secGroupSysadminMembSysadmin.setRequiredRevision(1);
			secGroupSysadminMembSysadmin.setRequiredOwnerCluster(systemClusterID);
			secGroupSysadminMembSysadmin.setRequiredContainerGroup(secGroupSysadminID);
			secGroupSysadminMembSysadmin.setRequiredParentUser(adminUID);
			secGroupSysadminMembSysadmin.setRequiredSecGrpMembId(secGroupSysadminMembSysadminID);
			secGroupSysadminMembSysadmin = ($SecSchemaName$JpaSecGrpMemb)(secgrpmembService.create(secGroupSysadminMembSysadmin));
			secGroupSysadminMembSysadminID = secGroupSysadminMembSysadmin.getRequiredSecGrpMembId();
		}

		if (bootstrapSession != null &amp;&amp; bootstrapSessionID != null &amp;&amp; !bootstrapSessionID.isNull() &amp;&amp; bootstrapSession.getOptionalFinish() == null) {
			bootstrapSession.setOptionalFinish(LocalDateTime.now());
			bootstrapSession = secsessionService.update(bootstrapSession);
		}
	}
</GenRule>

	<GenRule GenDef="Object" Name="implJpaSchemaServiceBootstrapAllTablesSecurity">$popto SchemaDef implJpaSchemaServiceBootstrapAllTablesSecurity$</GenRule>
	<GenRule GenDef="SchemaDef" Name="implJpaSchemaServiceBootstrapAllTablesSecurity">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower DefDbSchemaName$TransactionManager")
	public void bootstrapAllTablesSecurity() {
		LocalDateTime now = LocalDateTime.now();
		I$SecSchemaName$SecSession bootstrapSession;
		CFLibDbKeyHash256 bootstrapSessionID = new CFLibDbKeyHash256(0);

		I$SecSchemaName$Authorization auth = new $SecSchemaName$Authorization();
		auth.setAuthUuid6(CFLibUuid6.generateUuid6());
		auth.setSecClusterId(I$SecSchemaName$Schema.getSysClusterId());
		auth.setSecTenantId(I$SecSchemaName$Schema.getSysTenantId());
		auth.setSecSessionId(bootstrapSessionID);
//I$SecSchemaName$Schema.getSysTenantId(), I$SecSchemaName$Schema.getSysAdminId()
		bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getFactorySecSession().newRec();
		bootstrapSession.setRequiredRevision(1);
		bootstrapSession.setRequiredSecSessionId(bootstrapSessionID);
		bootstrapSession.setRequiredSecUserId(I$SecSchemaName$Schema.getSysAdminId());
		bootstrapSession.setOptionalSecProxyId(I$SecSchemaName$Schema.getSysAdminId());
		bootstrapSession.setOptionalSecDevName(null);
		bootstrapSession.setRequiredStart(now);
		bootstrapSession.setOptionalFinish(null);
		bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecSession().createSecSession(auth, bootstrapSession);
		bootstrapSessionID = bootstrapSession.getRequiredSecSessionId();
$iterate Tables( each maybeInvokeBootstrapTable empty empty )$

		if (bootstrapSession != null &amp;&amp; bootstrapSessionID != null &amp;&amp; !bootstrapSessionID.isNull() &amp;&amp; bootstrapSession.getOptionalFinish() == null) {
			bootstrapSession.setOptionalFinish(LocalDateTime.now());
			bootstrapSession = I$SecSchemaName$Schema.getBacking$SecSchemaName$().getTableSecSession().updateSecSession(auth, bootstrapSession);
		}
	}
</GenRule>

	<GenRule GenDef="Table" Name="maybeInvokeBootstrapTable">$switch HasDefSchema yes empty default invokeBootstrapTable$</GenRule>
	<GenRule GenDef="Table" Name="invokeBootstrapTable">
		bootstrapTable$TableName$Security(auth);</GenRule>

	<GenRule GenDef="Table" Name="maybeImplJpaSchemaServiceBootstrapTable">$switch HasDefSchema yes empty default implJpaSchemaServiceBootstrapTable$</GenRule>
	<GenRule GenDef="Table" Name="implJpaSchemaServiceBootstrapTable">
	@Transactional(propagation = Propagation.REQUIRED, noRollbackFor = NoResultException.class, transactionManager = "$lower DefDbSchemaName$TransactionManager")
	public void bootstrapTable$TableName$Security(I$SecSchemaName$Authorization auth) {
		LocalDateTime now = LocalDateTime.now();
$declGroupsAndMembers$
$resolveGroupsAndMembers$
$initGroupAndMemberIDs$
$createMissingGroupsAndMembers$
	}		
</GenRule>

</RuleSet>
