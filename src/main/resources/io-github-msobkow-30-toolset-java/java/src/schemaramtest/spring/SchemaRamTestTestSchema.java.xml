<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Mark's Code Fractal CFKBase 3.1 Code Fractal Knowledge Base
 *
 *	Copyright 2016-2026 Mark Stephen Sobkow
 *
 *	This file is part of Mark's Code Fractal CFKBase.
 *
 *	Mark's Code Fractal CFKBase is available under dual commercial license from
 *	Mark Stephen Sobkow, or under the terms of the GNU General Public License,
 *	Version 3 or later.
 *
 *	Mark's Code Fractal CFKBase is free software: you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	Mark's Code Fractal CFKBase is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Mark's Code Fractal CFKBase.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 *
 *	If you wish to modify and use this code without publishing your changes,
 *	or integrate it with proprietary code, please contact Mark Stephen Sobkow
 *	for a commercial license at mark.sobkow@gmail.com
 * -->
<RuleSet
	xmlns="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xsi:schemaLocation="https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd https://msobkow.github.io/msscf/2.0.13/xsd/cfgenkb-2.13-ruleset.xsd"
	ToolSet="java"
	Name="src/schemaramtest/spring/SchemaRamTestStartupListener.java"
	Revision="3.0"
	Descr="Java 25 Main for test creation of the Ram storage for the schema">

	<GenRule GenDef="SchemaRef" Name="fileSchemaRamTestTestSchemaJava">$reference RefSchema fileSchemaRamTestTestSchemaJava$</GenRule>

	<GenFile GenDef="SchemaDef" Name="fileSchemaRamTestTestSchemaJava"
			GenerateOnce="false"
		ModuleName="$reference ManufacturingSchema lower JavaPackage$"
		SourceBundle="java"
		BasePackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$ramtest/src/main/java"
		SubPackageName="$reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$ramtest.spring"
		ExpansionClassName="$SchemaName$RamTestTestSchemaJava"
		ExpansionKeyName="$SchemaName$RamTestTestSchemaJava"
		ExpansionFileName="$SchemaName$RamTestTestSchema.java">
// Description: Spring Ram storage tests for $SchemaName$ for the RamTest program

$MssSourceLicense$

package $reference ManufacturingSchema lower JavaPackage$.$reference ManufacturingSchema lower SchemaName$ramtest.spring;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.time.LocalDateTime;
import java.util.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import jakarta.persistence.EntityManager;
import jakarta.persistence.NoResultException;

import io.github.msobkow.v3_1.cflib.*;
import io.github.msobkow.v3_1.cflib.dbutil.*;$iterate SchemaRefs( each importJavaPackageSchemaName empty empty )$$iterate SchemaRefs( each importJavaPackageSchemaNameBuff empty empty )$$iterate SchemaRefs( each importJavaPackageSchemaNameRam empty empty )$$importJavaPackageSchemaName$$importJavaPackageSchemaNameBuff$$importJavaPackageSchemaNameRam$

@Service("RamTest$DefSchemaName$")
public class $SchemaName$RamTestTestSchema {
    
    public String performTests(EntityManager em) {
		StringBuffer messages = new StringBuffer("Starting $SchemaName$ tests...\n");$iterate SchemaRefs( empty implRamTestSchemaCFSec each empty )$$iterate Tables( each maybeRamTestSchemaTableSelectAll )$
		messages.append("$SchemaName$ tests complete\n");
		return( messages.toString() );
	}
$iterate SchemaRefs( empty implRamTestSchemaCFSecUtilityMethods each empty )$}</GenFile>

<GenRule GenDef="Object" Name="implRamTestSchemaCFSec">$popto SchemaDef reallyImplRamTestSchemaCFSec$</GenRule>
<GenRule GenDef="SchemaDef" Name="reallyImplRamTestSchemaCFSec">
		{
			try {
				LocalDateTime now = LocalDateTime.now();
				CFLibDbKeyHash256 adminpid = new CFLibDbKeyHash256("f012301230123012301230123012301230123012301230123012301230123012");
				CFLibDbKeyHash256 mgrpid =   new CFLibDbKeyHash256("fabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabc");
				I$DefSchemaName$SecUser secUserResults = I$DefSchemaName$Schema.getBacking$DefSchemaName$().getTableSecUser().readDerived(null, adminpid);
				if( secUserResults == null ) {
					$DefSchemaName$BuffSecUser newuser = ($DefSchemaName$BuffSecUser)(I$DefSchemaName$Schema.getBacking$DefSchemaName$().getFactorySecUser().newRec());
					newuser.setCreatedByUserId( adminpid );
					newuser.setCreatedAt( now );
					newuser.setUpdatedByUserId( adminpid );
					newuser.setUpdatedAt( now );
					newuser.setPKey(adminpid);
					newuser.setRequiredSecUserId( adminpid );
					newuser.setRequiredRevision( 1 );
					newuser.setOptionalLookupDefDev((ICFSecSecDevice)null);
					newuser.setRequiredLoginId( "admin" );
					newuser.setRequiredEMailAddress("admin@localhost");
					newuser.setOptionalEMailConfirmUuid6( null );
					newuser.setRequiredPasswordHash( computeSHA256("changeoninstall") );
					newuser.setOptionalPasswordResetUuid6( null );
					I$DefSchemaName$SecUser secUserCreated = I$DefSchemaName$Schema.getBacking$DefSchemaName$().getTableSecUser().createSecUser(null, newuser);
					if (secUserCreated == null) {
						messages.append("Error creating secuser admin - null returned\n");
					}
					else {
						messages.append("Created admin user: " + secUserCreated.toString() + "\n");
					}
				}
				else {
					messages.append("Admin user already exists: " + secUserResults.toString() + "\n");
				}
			}
			catch (Exception e) {
				String msg = "ERROR: performTests() Caught and rethrew " + e.getClass().getCanonicalName() + " while modifying or creating the 'admin' user - " + e.getMessage();
				messages.append(msg);
				System.err.println(msg);
				e.printStackTrace(System.err);
			}
		}
</GenRule>

<GenRule GenDef="Object" Name="implRamTestSchemaCFSecUtilityMethods">
	// From Google's AI
    /**
     * Computes the SHA-256 hash of a given string and returns it as a hex string.
     *
     * @param text The input string to hash.
     * @return The SHA-256 hash in hexadecimal format.
     */
    public static String computeSHA256(String text) {
        try {
            // Step 1: Get a MessageDigest instance for SHA-256
            MessageDigest digest = MessageDigest.getInstance("SHA-256");

            // Step 2: Convert the input string to bytes using UTF-8 encoding
            byte[] hashBytes = digest.digest(text.getBytes(StandardCharsets.UTF_8));

            // Step 3: Convert the byte array to a hexadecimal string
            StringBuilder hexString = new StringBuilder();
            for (byte b : hashBytes) {
                // Convert byte to hex (ensure two characters per byte)
                String hex = Integer.toHexString(0xff &amp; b);
                if (hex.length() == 1) {
                    hexString.append('0');
                }
                hexString.append(hex);
            }

            return hexString.toString();

        } catch (NoSuchAlgorithmException e) {
            // Handle the case where the algorithm is not available (highly unlikely for SHA-256)
            throw new RuntimeException("SHA-256 algorithm not available", e);
        }
    }
</GenRule>
<GenRule GenDef="Table" Name="maybeRamTestSchemaTableSelectAll">$switch HasDefSchema yes empty default ramTestSchemaTableSelectAll$</GenRule>
<GenRule GenDef="Table" Name="ramTestSchemaTableSelectAll">
		I$DefSchemaName$$TableName$[] $leadlower TableName$Results = I$DefSchemaName$Schema.getBacking$DefSchemaName$().getTable$TableName$().readAllDerived(null);
		if ($leadlower TableName$Results == null) {
			messages.append("Erroneously retrieved null for I$DefSchemaName$Schema.get$TableName$Table().readAllDerived(null)\n");
		}
		else {
			messages.append("Retrieved " + $leadlower TableName$Results.length + " entities from $DefSchemaName$.$TableName$\n");
		}
</GenRule>

</RuleSet>
